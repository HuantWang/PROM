<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>prom.regression.quantile_regression &mdash; Prom v0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Prom
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.html">prom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.conformity_scores.html">prom.conformity_scores package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.control_risk.html">prom.control_risk package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.estimator.html">prom.estimator package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.regression.html">prom.regression package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Thread Coarsening API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/thread/Deeptune_utils.html">Deeptune_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/thread/Magni_utils.html">Magni_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/thread/Thread_Deep.html">Thread_Deep module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/thread/Thread_i2v.html">Thread_i2v module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/thread/Thread_magni.html">Thread_magni module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Loop Tiling API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/Loop/Deeptune_utils.html">Deeptune_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/Loop/Loop_de.html">Loop_de module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/Loop/Loop_ma.html">Loop_ma module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/Loop/Loop_SVM.html">Loop_SVM module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/Loop/Loop_thread_sensitive.html">Loop_thread_sensitive module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/Loop/Magni_utils.html">Magni_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/Loop/Ml_utils.html">Ml_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/Loop/prom_util_sensitive.html">prom_util_sensitive module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Device Mapping API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/compy.datasets.html">compy.datasets package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/compy.models.graphs.html">compy.models.graphs package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/compy.models.graphs.tf.cell.html">compy.models.graphs.tf.cell package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/compy.models.graphs.tf.layer.html">compy.models.graphs.tf.layer package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/compy.models.graphs.tf.html">compy.models.graphs.tf package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/compy.models.html">compy.models package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/compy.models.seqs.html">compy.models.seqs package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/compy.representations.extractors.html">compy.representations.extractors package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/compy.representations.html">compy.representations package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/copy_pytorch_geom_model_sec.html">copy_pytorch_geom_model_sec module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/DevM_i2v.html">DevM_i2v module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/DevM_Programl.html">DevM_Programl module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/devmap_exploration.html">devmap_exploration module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/look.html">look module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/Mapie.html">Mapie module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/modules.html">DeviceM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/pytorch_geom_model_pchange.html">pytorch_geom_model_pchange module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/DeviceM/setup.html">setup module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tensor Tuning API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/autotvm_x.html">autotvm_x module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/bert_large.html">bert_large module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/bert_med.html">bert_med module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/bert_tiny.html">bert_tiny module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/common.html">common module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/dump_network_info.html">dump_network_info module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/dump_programs.html">dump_programs module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/estimate_network_latency.html">estimate_network_latency module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/eval_model_on_dataset.html">eval_model_on_dataset module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/lightgbm_bayesian_hyperparameter_opt.html">lightgbm_bayesian_hyperparameter_opt module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/make_dataset.html">make_dataset module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/measure_programs.html">measure_programs module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/modules.html">scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/mtl_tlp_make_dataset.html">mtl_tlp_make_dataset module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/mtl_tlp_train.html">mtl_tlp_train module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/network2measure_records.html">network2measure_records module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/nni_hyperparameter_opt.html">nni_hyperparameter_opt module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/print_all_tasks.html">print_all_tasks module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/print_programs.html">print_programs module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/search.html">search module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/sensitive.html">sensitive module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/tlp_eval.html">tlp_eval module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/tlp_fine_tune.html">tlp_fine_tune module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/tlp_make_dataset.html">tlp_make_dataset module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/tlp_make_dataset_bert.html">tlp_make_dataset_bert module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/tlp_preprocess_dataset_gpu.html">tlp_preprocess_dataset_gpu module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/train_model.html">train_model module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/train_tlp.html">train_tlp module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/tlp/tune_network.html">tune_network module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bug Detection API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/BugD/model.html">model module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/BugD/preprocess.html">preprocess module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/BugD/VD_codebert.html">VD_codebert module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../case_study/BugD/VD_vulde.html">VD_vulde module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Prom</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">prom.regression.quantile_regression</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for prom.regression.quantile_regression</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">RegressorMixin</span><span class="p">,</span> <span class="n">clone</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">QuantileRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">check_random_state</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.validation</span> <span class="kn">import</span> <span class="p">(</span><span class="n">_check_y</span><span class="p">,</span> <span class="n">_num_samples</span><span class="p">,</span> <span class="n">check_is_fitted</span><span class="p">,</span>
                                      <span class="n">indexable</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">src.prom._compatibility</span> <span class="kn">import</span> <span class="n">np_quantile</span>
<span class="kn">from</span> <span class="nn">src.prom._typing</span> <span class="kn">import</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">src.prom.utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">check_alpha_and_n_samples</span><span class="p">,</span>
                         <span class="n">check_defined_variables_predict_cqr</span><span class="p">,</span>
                         <span class="n">check_estimator_fit_predict</span><span class="p">,</span> <span class="n">check_lower_upper_bounds</span><span class="p">,</span>
                         <span class="n">check_null_weight</span><span class="p">,</span> <span class="n">fit_estimator</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.regression</span> <span class="kn">import</span> <span class="n">MapieRegressor</span>


<div class="viewcode-block" id="MapieQuantileRegressor"><a class="viewcode-back" href="../../../src/prom.regression.html#prom.regression.quantile_regression.MapieQuantileRegressor">[docs]</a><span class="k">class</span> <span class="nc">MapieQuantileRegressor</span><span class="p">(</span><span class="n">MapieRegressor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class implements the conformalized quantile regression strategy</span>
<span class="sd">    as proposed by Romano et al. (2019) to make conformal predictions.</span>
<span class="sd">    The only valid ``method`` is ``&quot;quantile&quot;`` and the only valid</span>
<span class="sd">    ``cv`` is ``&quot;split&quot;``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    estimator : Optional[RegressorMixin]</span>
<span class="sd">        Any regressor with scikit-learn API</span>
<span class="sd">        (i.e. with ``fit`` and ``predict`` methods).</span>
<span class="sd">        If ``None``, estimator defaults to a ``QuantileRegressor`` instance.</span>

<span class="sd">        By default ``&quot;None&quot;``.</span>

<span class="sd">    method: str</span>
<span class="sd">        Method to choose for prediction, in this case, the only valid method</span>
<span class="sd">        is the ``&quot;quantile&quot;`` method.</span>

<span class="sd">        By default ``&quot;quantile&quot;``.</span>

<span class="sd">    cv: Optional[str]</span>
<span class="sd">        The cross-validation strategy for computing conformity scores.</span>
<span class="sd">        In theory a split method is implemented as it is needed to provide</span>
<span class="sd">        both a training and calibration set.</span>

<span class="sd">        By default ``None``.</span>

<span class="sd">    alpha: float</span>
<span class="sd">        Between ``0.0`` and ``1.0``, represents the risk level of the</span>
<span class="sd">        confidence interval.</span>
<span class="sd">        Lower ``alpha`` produce larger (more conservative) prediction</span>
<span class="sd">        intervals.</span>
<span class="sd">        ``alpha`` is the complement of the target coverage level.</span>

<span class="sd">        By default ``0.1``.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    valid_methods_: List[str]</span>
<span class="sd">        List of all valid methods.</span>

<span class="sd">    single_estimator_: RegressorMixin</span>
<span class="sd">        Estimator fitted on the whole training set.</span>

<span class="sd">    estimators_: List[RegressorMixin]</span>
<span class="sd">        - [0]: Estimator with quantile value of alpha/2</span>
<span class="sd">        - [1]: Estimator with quantile value of 1 - alpha/2</span>
<span class="sd">        - [2]: Estimator with quantile value of 0.5</span>

<span class="sd">    conformity_scores_: NDArray of shape (n_samples_train, 3)</span>
<span class="sd">        Conformity scores between ``y_calib`` and ``y_pred``.</span>

<span class="sd">        - [:, 0]: for ``y_calib`` coming from prediction estimator</span>
<span class="sd">          with quantile of alpha/2</span>
<span class="sd">        - [:, 1]: for ``y_calib`` coming from prediction estimator</span>
<span class="sd">          with quantile of 1 - alpha/2</span>
<span class="sd">        - [:, 2]: maximum of those first two scores</span>

<span class="sd">    n_calib_samples: int</span>
<span class="sd">        Number of samples in the calibration dataset.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Yaniv Romano, Evan Patterson and Emmanuel J. Cand√®s.</span>
<span class="sd">    &quot;Conformalized Quantile Regression&quot;</span>
<span class="sd">    Advances in neural information processing systems 32 (2019).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from mapie.regression import MapieQuantileRegressor</span>
<span class="sd">    &gt;&gt;&gt; X_train = np.array([[0], [1], [2], [3], [4], [5]])</span>
<span class="sd">    &gt;&gt;&gt; y_train = np.array([5, 7.5, 9.5, 10.5, 12.5, 15])</span>
<span class="sd">    &gt;&gt;&gt; X_calib = np.array([[0], [1], [2], [3], [4], [5], [6], [7], [8], [9]])</span>
<span class="sd">    &gt;&gt;&gt; y_calib = np.array([5, 7, 9, 4, 8, 1, 5, 7.5, 9.5, 12])</span>
<span class="sd">    &gt;&gt;&gt; mapie_reg = MapieQuantileRegressor().fit(</span>
<span class="sd">    ...     X_train,</span>
<span class="sd">    ...     y_train,</span>
<span class="sd">    ...     X_calib=X_calib,</span>
<span class="sd">    ...     y_calib=y_calib</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; y_pred, y_pis = mapie_reg.predict(X_train)</span>
<span class="sd">    &gt;&gt;&gt; print(y_pis[:, :, 0])</span>
<span class="sd">    [[-8.16666667 19.        ]</span>
<span class="sd">     [-6.33333333 20.83333333]</span>
<span class="sd">     [-4.5        22.66666667]</span>
<span class="sd">     [-2.66666667 24.5       ]</span>
<span class="sd">     [-0.83333333 26.33333333]</span>
<span class="sd">     [ 1.         28.16666667]]</span>
<span class="sd">    &gt;&gt;&gt; print(y_pred)</span>
<span class="sd">    [ 5.  7.  9. 11. 13. 15.]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_methods_</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;quantile&quot;</span><span class="p">]</span>
    <span class="n">fit_attributes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;estimators_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;conformity_scores_&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n_calib_samples&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">quantile_estimator_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;GradientBoostingRegressor&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;loss_name&quot;</span><span class="p">:</span> <span class="s2">&quot;loss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alpha_name&quot;</span><span class="p">:</span> <span class="s2">&quot;alpha&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;QuantileRegressor&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;loss_name&quot;</span><span class="p">:</span> <span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alpha_name&quot;</span><span class="p">:</span> <span class="s2">&quot;quantile&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;HistGradientBoostingRegressor&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;loss_name&quot;</span><span class="p">:</span> <span class="s2">&quot;loss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alpha_name&quot;</span><span class="p">:</span> <span class="s2">&quot;quantile&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;LGBMRegressor&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;loss_name&quot;</span><span class="p">:</span> <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alpha_name&quot;</span><span class="p">:</span> <span class="s2">&quot;alpha&quot;</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">estimator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">RegressorMixin</span><span class="p">,</span>
                <span class="n">Pipeline</span><span class="p">,</span>
                <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">RegressorMixin</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">]]</span>
            <span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;quantile&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">estimator</span><span class="o">=</span><span class="n">estimator</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv</span> <span class="o">=</span> <span class="n">cv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="k">def</span> <span class="nf">_check_alpha</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform several checks on the alpha value and changes it from</span>
<span class="sd">        a float to an ArrayLike.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Can only be a float value between ``0.0`` and ``1.0``.</span>
<span class="sd">            Represent the risk level of the confidence interval.</span>
<span class="sd">            Lower alpha produce larger (more conservative) prediction</span>
<span class="sd">            intervals. Alpha is the complement of the target coverage level.</span>

<span class="sd">            By default ``0.1``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ArrayLike</span>
<span class="sd">            An ArrayLike of three values:</span>

<span class="sd">            - [0]: alpha value of alpha/2</span>
<span class="sd">            - [1]: alpha value of of 1 - alpha/2</span>
<span class="sd">            - [2]: alpha value of 0.5</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If alpha is not a float.</span>

<span class="sd">        ValueError</span>
<span class="sd">            If the value of ``alpha`` is not between ``0.0`` and ``1.0``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv</span> <span class="o">==</span> <span class="s2">&quot;prefit&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;WARNING: The alpha that is set needs to be the same&quot;</span>
                <span class="o">+</span> <span class="s2">&quot; as the alpha of your prefitted model in the following&quot;</span>
                <span class="s2">&quot; order [alpha/2, 1 - alpha/2, 0.5]&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">alpha</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid alpha. Allowed values are between 0.0 and 1.0.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid alpha. Allowed values are float.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">alpha_np</span>

    <span class="k">def</span> <span class="nf">_check_estimator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">estimator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">RegressorMixin</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">RegressorMixin</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform several checks on the estimator to check if it has</span>
<span class="sd">        all the required specifications to be used with this methodology.</span>
<span class="sd">        The estimators that can be used in MapieQuantileRegressor need to</span>
<span class="sd">        have a ``fit`` and ``predict`` attribute, but also need to allow</span>
<span class="sd">        a quantile loss and therefore also setting a quantile value.</span>
<span class="sd">        Note that there is a ``TypedDict`` to check which methods allow for</span>
<span class="sd">        quantile regression.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        estimator : Optional[RegressorMixin], optional</span>
<span class="sd">            Estimator to check, by default ``None``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RegressorMixin</span>
<span class="sd">            The estimator itself or a default ``QuantileRegressor`` instance</span>
<span class="sd">            with ``solver`` set to &quot;highs&quot;.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the estimator implements ``fit`` or ``predict`` methods.</span>

<span class="sd">        ValueError</span>
<span class="sd">            We check if it&#39;s a known estimator that does quantile regression</span>
<span class="sd">            according to the dictionnary set quantile_estimator_params.</span>
<span class="sd">            This dictionnary will need to be updated with the latest new</span>
<span class="sd">            available estimators.</span>

<span class="sd">        ValueError</span>
<span class="sd">            The estimator does not have the ``&quot;loss_name&quot;`` in its parameters</span>
<span class="sd">            and therefore can not be used as an estimator.</span>

<span class="sd">        ValueError</span>
<span class="sd">            There is no quantile ``&quot;loss_name&quot;`` and therefore this estimator</span>
<span class="sd">            can not be used as a ``MapieQuantileRegressor``.</span>

<span class="sd">        ValueError</span>
<span class="sd">            The parameter to set the alpha value does not exist in this</span>
<span class="sd">            estimator and therefore we cannot use it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">estimator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QuantileRegressor</span><span class="p">(</span>
                <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;highs-ds&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">check_estimator_fit_predict</span><span class="p">(</span><span class="n">estimator</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_estimator</span><span class="p">(</span><span class="n">estimator</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">estimator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_estimator</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">name_estimator</span> <span class="o">==</span> <span class="s2">&quot;QuantileRegressor&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">estimator</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name_estimator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantile_estimator_params</span><span class="p">:</span>
                    <span class="n">param_estimator</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
                    <span class="n">loss_name</span><span class="p">,</span> <span class="n">alpha_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantile_estimator_params</span><span class="p">[</span>
                        <span class="n">name_estimator</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">loss_name</span> <span class="ow">in</span> <span class="n">param_estimator</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">param_estimator</span><span class="p">[</span><span class="n">loss_name</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;quantile&quot;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">&quot;You need to set the loss/objective argument&quot;</span>
                                <span class="o">+</span> <span class="s2">&quot; of your base model to ``quantile``.&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">alpha_name</span> <span class="ow">in</span> <span class="n">param_estimator</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">estimator</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="s2">&quot;The matching parameter `alpha_name` for&quot;</span>
                                    <span class="s2">&quot; estimator does not exist. &quot;</span>
                                    <span class="s2">&quot;Make sure you set it when initializing &quot;</span>
                                    <span class="s2">&quot;your estimator.&quot;</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;The matching parameter `loss_name` for&quot;</span>
                            <span class="o">+</span> <span class="s2">&quot; estimator does not exist.&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;The base model does not seem to be accepted&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot; by MapieQuantileRegressor. </span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;Give a base model among: </span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantile_estimator_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;Or, add your base model to&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot; ``quantile_estimator_params``.&quot;</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_cv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if cv argument is ``None``, ``&quot;split&quot;`` or ``&quot;prefit&quot;``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cv : Optional[str], optional</span>
<span class="sd">           cv to check, by default ``None``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            cv itself or a default ``&quot;split&quot;``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            Raises an error if the cv is anything else but the method</span>
<span class="sd">            ``&quot;split&quot;`` or ``&quot;prefit&quot;``.</span>
<span class="sd">            Only the split method has been implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;split&quot;</span>
        <span class="k">if</span> <span class="n">cv</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="s2">&quot;prefit&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid cv method, only valid method is ``split``.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_calib_set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">X_calib</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">y_calib</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">calib_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="n">random_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">stratify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a calibration set has already been defined, if not, then</span>
<span class="sd">        we define one using the ``train_test_split`` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Same definition of parameters as for the ``fit`` method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[ArrayLike, ArrayLike, ArrayLike, ArrayLike, ArrayLike]</span>
<span class="sd">            - [0]: ArrayLike of shape (n_samples_*(1-calib_size), n_features)</span>
<span class="sd">                X_train</span>
<span class="sd">            - [1]: ArrayLike of shape (n_samples_*(1-calib_size),)</span>
<span class="sd">                y_train</span>
<span class="sd">            - [2]: ArrayLike of shape (n_samples_*calib_size, n_features)</span>
<span class="sd">                X_calib</span>
<span class="sd">            - [3]: ArrayLike of shape (n_samples_*calib_size,)</span>
<span class="sd">                y_calib</span>
<span class="sd">            - [4]: ArrayLike of shape (n_samples_,)</span>
<span class="sd">                sample_weight_train</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">X_calib</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y_calib</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sample_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">X_train</span><span class="p">,</span> <span class="n">X_calib</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_calib</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                        <span class="n">X</span><span class="p">,</span>
                        <span class="n">y</span><span class="p">,</span>
                        <span class="n">test_size</span><span class="o">=</span><span class="n">calib_size</span><span class="p">,</span>
                        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
                        <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                        <span class="n">stratify</span><span class="o">=</span><span class="n">stratify</span>
                <span class="p">)</span>
                <span class="n">sample_weight_train</span> <span class="o">=</span> <span class="n">sample_weight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span>
                        <span class="n">X_train</span><span class="p">,</span>
                        <span class="n">X_calib</span><span class="p">,</span>
                        <span class="n">y_train</span><span class="p">,</span>
                        <span class="n">y_calib</span><span class="p">,</span>
                        <span class="n">sample_weight_train</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
                        <span class="n">X</span><span class="p">,</span>
                        <span class="n">y</span><span class="p">,</span>
                        <span class="n">sample_weight</span><span class="p">,</span>
                        <span class="n">test_size</span><span class="o">=</span><span class="n">calib_size</span><span class="p">,</span>
                        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
                        <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                        <span class="n">stratify</span><span class="o">=</span><span class="n">stratify</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">sample_weight_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_calib</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">X_train</span><span class="p">),</span> <span class="n">cast</span><span class="p">(</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">X_calib</span><span class="p">)</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_calib</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="n">cast</span><span class="p">(</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y_calib</span><span class="p">)</span>
        <span class="n">sample_weight_train</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">sample_weight_train</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_calib</span><span class="p">,</span> <span class="n">y_calib</span><span class="p">,</span> <span class="n">sample_weight_train</span>

    <span class="k">def</span> <span class="nf">_check_prefit_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">estimator</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">RegressorMixin</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the parameters set for the specific case of prefit</span>
<span class="sd">        estimators.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        estimator : List[Union[RegressorMixin, Pipeline]]</span>
<span class="sd">            List of three prefitted estimators that should have</span>
<span class="sd">            pre-defined quantile levels of alpha/2, 1 - alpha/2 and 0.5.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If a non-iterable variable is provided for estimator.</span>

<span class="sd">        ValueError</span>
<span class="sd">            If less or more than three models are defined.</span>

<span class="sd">        Warning</span>
<span class="sd">            If the alpha is defined, warns the user that it must be set</span>
<span class="sd">            accordingly with the prefit estimators.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Estimator for prefit must be an iterable object.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimator</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">est</span> <span class="ow">in</span> <span class="n">estimator</span><span class="p">:</span>
                <span class="n">check_estimator_fit_predict</span><span class="p">(</span><span class="n">est</span><span class="p">)</span>
                <span class="n">check_is_fitted</span><span class="p">(</span><span class="n">est</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You need to have provided 3 different estimators, they&quot;</span>
                <span class="s2">&quot; need to be preset with alpha values in the following&quot;</span>
                <span class="s2">&quot; order [alpha/2, 1 - alpha/2, 0.5].&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="MapieQuantileRegressor.fit"><a class="viewcode-back" href="../../../src/prom.regression.html#prom.regression.quantile_regression.MapieQuantileRegressor.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">sample_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">groups</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">X_calib</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">y_calib</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">calib_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span>
        <span class="n">random_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">stratify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">fit_params</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MapieQuantileRegressor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit estimator and compute residuals used for prediction intervals.</span>
<span class="sd">        All the clones of the estimators for different quantile values are</span>
<span class="sd">        stored in order alpha/2, 1 - alpha/2, 0.5 in the ``estimators_``</span>
<span class="sd">        attribute. Residuals for the first two estimators and the maximum</span>
<span class="sd">        of residuals among these residuals are stored in the</span>
<span class="sd">        ``conformity_scores_`` attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X: ArrayLike of shape (n_samples, n_features)</span>
<span class="sd">            Training data.</span>

<span class="sd">        y: ArrayLike of shape (n_samples,)</span>
<span class="sd">            Training labels.</span>

<span class="sd">        sample_weight: Optional[ArrayLike] of shape (n_samples,)</span>
<span class="sd">            Sample weights for fitting the out-of-fold models.</span>
<span class="sd">            If ``None``, then samples are equally weighted.</span>
<span class="sd">            If some weights are null,</span>
<span class="sd">            their corresponding observations are removed</span>
<span class="sd">            before the fitting process and hence have no residuals.</span>
<span class="sd">            If weights are non-uniform, residuals are still uniformly weighted.</span>
<span class="sd">            Note that the sample weight defined are only for the training, not</span>
<span class="sd">            for the calibration procedure.</span>

<span class="sd">            By default ``None``.</span>

<span class="sd">        groups: Optional[ArrayLike] of shape (n_samples,)</span>
<span class="sd">            Always ignored, exists for compatibility.</span>

<span class="sd">        X_calib: Optional[ArrayLike] of shape (n_calib_samples, n_features)</span>
<span class="sd">            Calibration data.</span>

<span class="sd">        y_calib: Optional[ArrayLike] of shape (n_calib_samples,)</span>
<span class="sd">            Calibration labels.</span>

<span class="sd">        calib_size: Optional[float]</span>
<span class="sd">            If ``X_calib`` and ``y_calib`` are not defined,</span>
<span class="sd">            then the calibration dataset is created with the split</span>
<span class="sd">            defined by ``calib_size``.</span>

<span class="sd">        random_state: Optional[Union[int, np.random.RandomState]], default=None</span>
<span class="sd">            For the ``sklearn.model_selection.train_test_split`` documentation.</span>
<span class="sd">            Controls the shuffling applied to the data before applying the</span>
<span class="sd">            split.</span>
<span class="sd">            Pass an int for reproducible output across multiple function calls.</span>
<span class="sd">            See :term:`Glossary &lt;random_state&gt;`.</span>

<span class="sd">            By default ``None``.</span>

<span class="sd">        shuffle: bool, default=True</span>
<span class="sd">            For the ``sklearn.model_selection.train_test_split`` documentation.</span>
<span class="sd">            Whether or not to shuffle the data before splitting.</span>
<span class="sd">            If ``shuffle=False`` then stratify must be None.</span>

<span class="sd">            By default ``True``.</span>

<span class="sd">        stratify: array-like, default=None</span>
<span class="sd">            For the ``sklearn.model_selection.train_test_split`` documentation.</span>
<span class="sd">            If not ``None``, data is split in a stratified fashion, using this</span>
<span class="sd">            as the class labels.</span>
<span class="sd">            Read more in the :ref:`User Guide &lt;stratification&gt;`.</span>

<span class="sd">            By default ``None``.</span>

<span class="sd">        **fit_params : dict</span>
<span class="sd">            Additional fit parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MapieQuantileRegressor</span>
<span class="sd">             The model itself.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_cv</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv</span><span class="p">))</span>

        <span class="c1"># Initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RegressorMixin</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv</span> <span class="o">==</span> <span class="s2">&quot;prefit&quot;</span><span class="p">:</span>
            <span class="n">estimator</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span><span class="p">)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_prefit_params</span><span class="p">(</span><span class="n">estimator</span><span class="p">)</span>
            <span class="n">X_calib</span><span class="p">,</span> <span class="n">y_calib</span> <span class="o">=</span> <span class="n">indexable</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">n_calib_samples</span> <span class="o">=</span> <span class="n">_num_samples</span><span class="p">(</span><span class="n">y_calib</span><span class="p">)</span>
            <span class="n">y_calib_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_calib_samples</span><span class="p">),</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">estimator</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">est</span><span class="p">)</span>
                <span class="n">y_calib_preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_calib</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_estimator_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Checks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_parameters</span><span class="p">()</span>
            <span class="n">checked_estimator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_estimator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator</span><span class="p">)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">indexable</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">random_state</span> <span class="o">=</span> <span class="n">check_random_state</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_calib_set</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span>
                <span class="n">y</span><span class="p">,</span>
                <span class="n">sample_weight</span><span class="p">,</span>
                <span class="n">X_calib</span><span class="p">,</span>
                <span class="n">y_calib</span><span class="p">,</span>
                <span class="n">calib_size</span><span class="p">,</span>
                <span class="n">random_state</span><span class="p">,</span>
                <span class="n">shuffle</span><span class="p">,</span>
                <span class="n">stratify</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_calib</span><span class="p">,</span> <span class="n">y_calib</span><span class="p">,</span> <span class="n">sample_weight_train</span> <span class="o">=</span> <span class="n">results</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">indexable</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">X_calib</span><span class="p">,</span> <span class="n">y_calib</span> <span class="o">=</span> <span class="n">indexable</span><span class="p">(</span><span class="n">X_calib</span><span class="p">,</span> <span class="n">y_calib</span><span class="p">)</span>
            <span class="n">y_train</span><span class="p">,</span> <span class="n">y_calib</span> <span class="o">=</span> <span class="n">_check_y</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> <span class="n">_check_y</span><span class="p">(</span><span class="n">y_calib</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_calib_samples</span> <span class="o">=</span> <span class="n">_num_samples</span><span class="p">(</span><span class="n">y_calib</span><span class="p">)</span>
            <span class="n">check_alpha_and_n_samples</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_calib_samples</span><span class="p">)</span>
            <span class="n">sample_weight_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">check_null_weight</span><span class="p">(</span>
                <span class="n">sample_weight_train</span><span class="p">,</span>
                <span class="n">X_train</span><span class="p">,</span>
                <span class="n">y_train</span>
            <span class="p">)</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

            <span class="n">y_calib_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_calib_samples</span><span class="p">),</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checked_estimator</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
                <span class="n">estimator</span> <span class="o">=</span> <span class="n">checked_estimator</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">estimator</span> <span class="o">=</span> <span class="n">checked_estimator</span>
            <span class="n">name_estimator</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">alpha_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantile_estimator_params</span><span class="p">[</span>
                <span class="n">name_estimator</span>
            <span class="p">][</span><span class="s2">&quot;alpha_name&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">alpha_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
                <span class="n">cloned_estimator_</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">checked_estimator</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">alpha_name</span><span class="p">:</span> <span class="n">alpha_</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">checked_estimator</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
                    <span class="n">cloned_estimator_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cloned_estimator_</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit_estimator</span><span class="p">(</span>
                    <span class="n">cloned_estimator_</span><span class="p">,</span>
                    <span class="n">X_train</span><span class="p">,</span>
                    <span class="n">y_train</span><span class="p">,</span>
                    <span class="n">sample_weight_train</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">fit_params</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">y_calib_preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_calib</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_estimator_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conformity_scores_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_calib_samples</span><span class="p">),</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_calib_preds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_calib</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_calib</span> <span class="o">-</span> <span class="n">y_calib_preds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="MapieQuantileRegressor.predict"><a class="viewcode-back" href="../../../src/prom.regression.html#prom.regression.quantile_regression.MapieQuantileRegressor.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
        <span class="n">ensemble</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimize_beta</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">allow_infinite_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">symmetry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Predict target on new samples with confidence intervals.</span>
<span class="sd">        Residuals from the training set and predictions from the model clones</span>
<span class="sd">        are central to the computation.</span>
<span class="sd">        Prediction Intervals for a given ``alpha`` are deduced from the</span>
<span class="sd">        quantile regression at the alpha values: alpha/2, 1 - (alpha/2)</span>
<span class="sd">        while adding a constant based uppon their residuals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X: ArrayLike of shape (n_samples, n_features)</span>
<span class="sd">            Test data.</span>

<span class="sd">        ensemble: bool</span>
<span class="sd">            Ensemble has not been defined in predict and therefore should</span>
<span class="sd">            will not have any effects in this method.</span>

<span class="sd">        alpha: Optional[Union[float, Iterable[float]]]</span>
<span class="sd">            For ``MapieQuantileRegresor`` the alpha has to be defined</span>
<span class="sd">            directly in initial arguments of the class.</span>

<span class="sd">        symmetry: Optional[bool]</span>
<span class="sd">            Deciding factor to whether to find the quantile value for</span>
<span class="sd">            each residuals separatly or to use the maximum of the two</span>
<span class="sd">            combined.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[NDArray, Tuple[NDArray, NDArray]]</span>
<span class="sd">            - NDArray of shape (n_samples,) if ``alpha`` is ``None``.</span>
<span class="sd">            - Tuple[NDArray, NDArray] of shapes (n_samples,) and</span>
<span class="sd">              (n_samples, 2, n_alpha) if ``alpha`` is not ``None``.</span>
<span class="sd">                - [:, 0, :]: Lower bound of the prediction interval.</span>
<span class="sd">                - [:, 1, :]: Upper bound of the prediction interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_attributes</span><span class="p">)</span>
        <span class="n">check_defined_variables_predict_cqr</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="k">if</span> <span class="n">symmetry</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">check_alpha_and_n_samples</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_calib_samples</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_calib_samples</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">n</span><span class="p">))</span>

        <span class="n">y_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">_num_samples</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">est</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="p">):</span>
            <span class="n">y_preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">est</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">check_lower_upper_bounds</span><span class="p">(</span><span class="n">y_preds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_preds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_preds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">symmetry</span><span class="p">:</span>
            <span class="n">quantile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="n">np_quantile</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">q</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;higher&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quantile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">np_quantile</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;higher&quot;</span>
                    <span class="p">),</span>
                    <span class="n">np_quantile</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;higher&quot;</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">y_pred_low</span> <span class="o">=</span> <span class="n">y_preds</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">quantile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_pred_up</span> <span class="o">=</span> <span class="n">y_preds</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">quantile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">check_lower_upper_bounds</span><span class="p">(</span><span class="n">y_pred_low</span><span class="p">,</span> <span class="n">y_pred_up</span><span class="p">,</span> <span class="n">y_preds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">y_preds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">y_pred_low</span><span class="p">,</span> <span class="n">y_pred_up</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, _.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>