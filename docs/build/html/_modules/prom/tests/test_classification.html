<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>prom.tests.test_classification &mdash; Prom v0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Prom
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.html">prom module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/util.html">util module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.conformity_scores.html">prom.conformity_scores package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.control_risk.html">prom.control_risk package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.estimator.html">prom.estimator package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.regression.html">prom.regression package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/prom.tests.html">prom.tests package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Prom</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">prom.tests.test_classification</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for prom.tests.test_classification</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">ClassifierMixin</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="p">(</span><span class="n">GroupKFold</span><span class="p">,</span> <span class="n">KFold</span><span class="p">,</span> <span class="n">LeaveOneOut</span><span class="p">,</span>
                                     <span class="n">ShuffleSplit</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.estimator_checks</span> <span class="kn">import</span> <span class="n">check_estimator</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.validation</span> <span class="kn">import</span> <span class="n">check_is_fitted</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span> <span class="nn">mapie._typing</span> <span class="kn">import</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">mapie.classification</span> <span class="kn">import</span> <span class="n">MapieClassifier</span>
<span class="kn">from</span> <span class="nn">mapie.metrics</span> <span class="kn">import</span> <span class="n">classification_coverage_score</span>
<span class="kn">from</span> <span class="nn">mapie.utils</span> <span class="kn">import</span> <span class="n">check_alpha</span>

<span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span>

<span class="n">METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span> <span class="s2">&quot;aps&quot;</span><span class="p">,</span> <span class="s2">&quot;raps&quot;</span><span class="p">]</span>
<span class="n">WRONG_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulated&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
<span class="n">WRONG_INCLUDE_LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;randomised&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
<span class="n">Y_PRED_PROBA_WRONG</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="n">Y_TRUE_PROBA_PLACE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mf">.1</span><span class="p">,</span> <span class="mf">.3</span><span class="p">,</span> <span class="mf">.6</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">.2</span><span class="p">,</span> <span class="mf">.7</span><span class="p">,</span> <span class="mf">.1</span><span class="p">]</span>
        <span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="p">],</span>
    <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="mf">.7</span><span class="p">,</span> <span class="mf">.12</span><span class="p">,</span> <span class="mf">.18</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.24</span><span class="p">,</span> <span class="mf">.26</span><span class="p">]</span>
        <span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="p">]</span>
<span class="p">]</span>

<span class="n">Params</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
    <span class="s2">&quot;Params&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s2">&quot;cv&quot;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="s2">&quot;test_size&quot;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="s2">&quot;random_state&quot;</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">ParamsPredict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
    <span class="s2">&quot;ParamsPredict&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;include_last_label&quot;</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="s2">&quot;agg_scores&quot;</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">STRATEGIES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lac&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;lac_split&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;lac_cv_mean&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;lac_cv_crossval&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;crossval&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_include&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_not_include&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_randomized&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="s2">&quot;randomized&quot;</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_include_split&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_not_include_split&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_randomized_split&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="s2">&quot;randomized&quot;</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_include_cv_mean&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_not_include_cv_mean&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_randomized_cv_mean&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="s2">&quot;randomized&quot;</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_include_cv_crossval&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;crossval&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_not_include_cv_crossval&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;crossval&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;aps_randomized_cv_crossval&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="s2">&quot;randomized&quot;</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;crossval&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;naive&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;naive&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;naive_split&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;naive&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;top_k_split&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;raps&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;raps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;raps_split&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;raps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;raps_randomized&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;raps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="s2">&quot;randomized&quot;</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;raps_randomized_split&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;raps&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="s2">&quot;randomized&quot;</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
<span class="p">}</span>

<span class="n">STRATEGIES_BINARY</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lac&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;lac_split&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;split&quot;</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;lac_cv_mean&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span>
        <span class="p">)</span>
    <span class="p">),</span>
    <span class="s2">&quot;lac_cv_crossval&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">Params</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
            <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">),</span>
        <span class="n">ParamsPredict</span><span class="p">(</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">agg_scores</span><span class="o">=</span><span class="s2">&quot;crossval&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="n">COVERAGES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lac&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;lac_split&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;lac_cv_mean&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;lac_cv_crossval&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;aps_include&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;aps_not_include&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;aps_randomized&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;aps_include_split&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;aps_not_include_split&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;aps_randomized_split&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;aps_include_cv_mean&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;aps_not_include_cv_mean&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;aps_randomized_cv_mean&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;aps_include_cv_crossval&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;aps_not_include_cv_crossval&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;aps_randomized_cv_crossval&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;naive&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;naive_split&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;top_k_split&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;raps&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;raps_split&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;raps_randomized&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;raps_randomized_split&quot;</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="p">}</span>

<span class="n">COVERAGES_BINARY</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lac&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;lac_split&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;lac_cv_mean&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;lac_cv_crossval&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="o">/</span><span class="mi">9</span>
<span class="p">}</span>

<span class="n">X_toy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y_toy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">y_toy_string</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">])</span>

<span class="n">y_toy_mapie</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lac&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;lac_split&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="s2">&quot;lac_cv_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;lac_cv_crossval&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_include&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_not_include&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_randomized&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_include_split&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_not_include_split&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_randomized_split&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_include_cv_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_not_include_cv_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_randomized_cv_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_include_cv_crossval&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_not_include_cv_crossval&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;aps_randomized_cv_crossval&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;naive&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;naive_split&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;top_k_split&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;raps&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;raps_split&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;raps_randomized&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;raps_randomized_split&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">X_toy_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y_toy_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">y_toy_binary_mapie</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;lac&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;lac_split&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;lac_cv_mean&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">],</span>
    <span class="s2">&quot;lac_cv_crossval&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
        <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="n">REGULARIZATION_PARAMETERS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">.001</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
    <span class="p">[[</span><span class="mf">.01</span><span class="p">,</span> <span class="mf">.2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
    <span class="p">[</span><span class="mf">.1</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
<span class="p">]</span>

<span class="n">IMAGE_INPUT</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;X_calib&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="s2">&quot;X_test&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;X_calib&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
        <span class="s2">&quot;X_test&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;X_calib&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">)),</span>
        <span class="s2">&quot;X_test&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">)),</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">X_good_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">y_toy_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">n_classes</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">n_features</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">n_informative</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">n_classes</span><span class="o">=</span><span class="n">n_classes</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="CumulatedScoreClassifier"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.CumulatedScoreClassifier">[docs]</a><span class="k">class</span> <span class="nc">CumulatedScoreClassifier</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_calib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_calib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_calib_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.750183952461055</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.029571416154050345</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.9268006058188594</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_pred_sets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_calib</span>

<div class="viewcode-block" id="CumulatedScoreClassifier.fit"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.CumulatedScoreClassifier.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CumulatedScoreClassifier</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="CumulatedScoreClassifier.predict"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.CumulatedScoreClassifier.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="CumulatedScoreClassifier.predict_proba"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.CumulatedScoreClassifier.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">.7</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]]</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="ImageClassifier"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.ImageClassifier">[docs]</a><span class="k">class</span> <span class="nc">ImageClassifier</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_calib</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">X_test</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_calib</span> <span class="o">=</span> <span class="n">X_calib</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_calib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_calib_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">0.750183952461055</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.029571416154050345</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.9268006058188594</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_pred_sets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_calib</span>

<div class="viewcode-block" id="ImageClassifier.fit"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.ImageClassifier.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImageClassifier</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ImageClassifier.predict"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.ImageClassifier.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="ImageClassifier.predict_proba"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.ImageClassifier.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]]</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="WrongOutputModel"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.WrongOutputModel">[docs]</a><span class="k">class</span> <span class="nc">WrongOutputModel</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proba_out</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trained_</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proba_out</span> <span class="o">=</span> <span class="n">proba_out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">proba_out</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

<div class="viewcode-block" id="WrongOutputModel.fit"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.WrongOutputModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Dummy fit.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="WrongOutputModel.predict_proba"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.WrongOutputModel.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proba_out</span></div>

<div class="viewcode-block" id="WrongOutputModel.predict"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.WrongOutputModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proba_out</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">proba_out</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred</span></div></div>


<div class="viewcode-block" id="Float32OuputModel"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.Float32OuputModel">[docs]</a><span class="k">class</span> <span class="nc">Float32OuputModel</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trained_</span> <span class="o">=</span> <span class="n">prefit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes_</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

<div class="viewcode-block" id="Float32OuputModel.fit"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.Float32OuputModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Dummy fit.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trained_</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Float32OuputModel.predict_proba"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.Float32OuputModel.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="n">probas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">.9</span><span class="p">,</span> <span class="mf">.05</span><span class="p">,</span> <span class="mf">.05</span><span class="p">]])</span>
        <span class="n">proba_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">probas</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">proba_out</span></div>

<div class="viewcode-block" id="Float32OuputModel.predict"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.Float32OuputModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">))</span></div>

<div class="viewcode-block" id="Float32OuputModel.get_params"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.Float32OuputModel.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;prefit&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div></div>


<div class="viewcode-block" id="do_nothing"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.do_nothing">[docs]</a><span class="k">def</span> <span class="nf">do_nothing</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="s2">&quot;Mock function that does nothing.&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="test_mapie_classifier_sklearn_estim"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_mapie_classifier_sklearn_estim">[docs]</a><span class="k">def</span> <span class="nf">test_mapie_classifier_sklearn_estim</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that MapieClassifier is an sklearn estimator&quot;&quot;&quot;</span>
    <span class="n">check_estimator</span><span class="p">(</span><span class="n">MapieClassifier</span><span class="p">())</span></div>


<div class="viewcode-block" id="test_initialized"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_initialized">[docs]</a><span class="k">def</span> <span class="nf">test_initialized</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that initialization does not crash.&quot;&quot;&quot;</span>
    <span class="n">MapieClassifier</span><span class="p">()</span></div>


<div class="viewcode-block" id="test_default_parameters"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_default_parameters">[docs]</a><span class="k">def</span> <span class="nf">test_default_parameters</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test default values of input parameters.&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;lac&quot;</span></div>


<div class="viewcode-block" id="test_warning_binary_classif"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_warning_binary_classif">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="s2">&quot;split&quot;</span><span class="p">])</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span> <span class="s2">&quot;raps&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_warning_binary_classif</span><span class="p">(</span><span class="n">cv</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that a warning is raised y is binary.&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
      <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">n_features</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">n_informative</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*Invalid method for binary target.*&quot;</span>
    <span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_binary_classif_same_result"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_binary_classif_same_result">[docs]</a><span class="k">def</span> <span class="nf">test_binary_classif_same_result</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test MAPIE doesnt change model output when y is binary.&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">n_features</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">n_informative</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mapie_predict</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">multi_class</span><span class="o">=</span><span class="s2">&quot;multinomial&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">lr_predict</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">mapie_predict</span><span class="p">,</span> <span class="n">lr_predict</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_valid_estimator"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_valid_estimator">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_valid_estimator</span><span class="p">(</span><span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that valid estimators are not corrupted, for all strategies.&quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="o">**</span><span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapie_clf</span><span class="o">.</span><span class="n">single_estimator_</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_valid_method"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_valid_method">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="n">METHODS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_valid_method</span><span class="p">(</span><span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that valid methods raise no errors.&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">check_is_fitted</span><span class="p">(</span><span class="n">mapie_clf</span><span class="p">,</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit_attributes</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_valid_cv"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_valid_cv">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">KFold</span><span class="p">(),</span> <span class="n">LeaveOneOut</span><span class="p">(),</span> <span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
           <span class="n">ShuffleSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_valid_cv</span><span class="p">(</span><span class="n">cv</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that valid cv raises no errors.&quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">multi_class</span><span class="o">=</span><span class="s2">&quot;multinomial&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_agg_scores_argument"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_agg_scores_argument">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;crossval&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_agg_scores_argument</span><span class="p">(</span><span class="n">agg_scores</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that predict passes with all valid &#39;agg_scores&#39; arguments.&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">agg_scores</span><span class="o">=</span><span class="n">agg_scores</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_invalid_agg_scores_argument"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_invalid_agg_scores_argument">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_invalid_agg_scores_argument</span><span class="p">(</span><span class="n">agg_scores</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that invalid &#39;agg_scores&#39; raise errors.&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*Invalid &#39;agg_scores&#39; argument.*&quot;</span>
    <span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">agg_scores</span><span class="o">=</span><span class="n">agg_scores</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_too_large_cv"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_too_large_cv">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_too_large_cv</span><span class="p">(</span><span class="n">cv</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that too large cv raise sklearn errors.&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="ne">ValueError</span><span class="p">,</span>
        <span class="n">match</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;.*Cannot have number of splits n_splits=</span><span class="si">{</span><span class="n">cv</span><span class="si">}</span><span class="s2"> greater.*&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_invalid_include_last_label"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_invalid_include_last_label">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;include_last_label&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="o">-</span><span class="mf">3.14</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="n">DummyClassifier</span><span class="p">(),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_invalid_include_last_label</span><span class="p">(</span><span class="n">include_last_label</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that invalid include_last_label raise errors.&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*Invalid include_last_label argument.*&quot;</span>
    <span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">X_toy</span><span class="p">,</span>
            <span class="n">y_toy</span><span class="p">,</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="n">include_last_label</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="test_predict_output_shape"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_predict_output_shape">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_predict_output_shape</span><span class="p">(</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test predict output shape.&quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_ps</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">n_alpha</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
    <span class="k">assert</span> <span class="n">y_ps</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">n_alpha</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_y_is_list_of_string"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_y_is_list_of_string">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_y_is_list_of_string</span><span class="p">(</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test predict output shape with string y.&quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">))</span>
    <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_ps</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">n_alpha</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
    <span class="k">assert</span> <span class="n">y_ps</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">n_alpha</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_same_results_prefit_split"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_same_results_prefit_split">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;naive&quot;</span><span class="p">,</span> <span class="s2">&quot;top_k&quot;</span><span class="p">,</span> <span class="s2">&quot;lac&quot;</span><span class="p">,</span> <span class="s2">&quot;aps_include&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_same_results_prefit_split</span><span class="p">(</span><span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test checking that if split and prefit method have exactly</span>
<span class="sd">    the same data split, then we have exactly the same results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">n_features</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">n_informative</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="n">n_classes</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="n">ShuffleSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">train_index</span><span class="p">,</span> <span class="n">val_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
    <span class="n">X_train_</span><span class="p">,</span> <span class="n">X_calib_</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">val_index</span><span class="p">]</span>
    <span class="n">y_train_</span><span class="p">,</span> <span class="n">y_calib_</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">train_index</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">val_index</span><span class="p">]</span>

    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span> <span class="o">+</span> <span class="s1">&#39;_split&#39;</span><span class="p">])</span>
    <span class="n">args_init</span><span class="p">[</span><span class="s2">&quot;cv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span>
    <span class="n">mapie_reg</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">y_pred_1</span><span class="p">,</span> <span class="n">y_pis_1</span> <span class="o">=</span> <span class="n">mapie_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">**</span><span class="n">args_predict</span><span class="p">)</span>

    <span class="n">args_init</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_</span><span class="p">,</span> <span class="n">y_train_</span><span class="p">)</span>
    <span class="n">mapie_reg</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_reg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_calib_</span><span class="p">,</span> <span class="n">y_calib_</span><span class="p">)</span>
    <span class="n">y_pred_2</span><span class="p">,</span> <span class="n">y_pis_2</span> <span class="o">=</span> <span class="n">mapie_reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">**</span><span class="n">args_predict</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pred_1</span><span class="p">,</span> <span class="n">y_pred_2</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pis_1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_pis_2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pis_1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_pis_2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="test_same_result_y_numeric_and_string"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_same_result_y_numeric_and_string">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_same_result_y_numeric_and_string</span><span class="p">(</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that MAPIE outputs the same results if y is</span>
<span class="sd">    numeric or string&quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">mapie_clf_str</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf_str</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">))</span>
    <span class="n">mapie_clf_int</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf_int</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_ps_str</span> <span class="o">=</span> <span class="n">mapie_clf_str</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_ps_int</span> <span class="o">=</span> <span class="n">mapie_clf_int</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps_int</span><span class="p">,</span> <span class="n">y_ps_str</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_y_1_to_l_minus_1"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_y_1_to_l_minus_1">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_y_1_to_l_minus_1</span><span class="p">(</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test predict output shape with string y.&quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_ps</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">n_alpha</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
    <span class="k">assert</span> <span class="n">y_ps</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">n_alpha</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_same_result_y_numeric_and_1_to_l_minus_1"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_same_result_y_numeric_and_1_to_l_minus_1">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_same_result_y_numeric_and_1_to_l_minus_1</span><span class="p">(</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that MAPIE outputs the same results if y is</span>
<span class="sd">    numeric or string&quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">mapie_clf_1</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf_1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mapie_clf_int</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf_int</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_ps_1</span> <span class="o">=</span> <span class="n">mapie_clf_1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_ps_int</span> <span class="o">=</span> <span class="n">mapie_clf_int</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps_int</span><span class="p">,</span> <span class="n">y_ps_1</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_results_for_same_alpha"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_results_for_same_alpha">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_results_for_same_alpha</span><span class="p">(</span><span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that predictions and intervals</span>
<span class="sd">    are similar with two equal values of alpha.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_ps</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_ps</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_ps</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="test_results_for_alpha_as_float_and_arraylike"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_results_for_alpha_as_float_and_arraylike">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]),</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_results_for_alpha_as_float_and_arraylike</span><span class="p">(</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that output values do not depend on type of alpha.&quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">y_pred_float1</span><span class="p">,</span> <span class="n">y_ps_float1</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">y_pred_float2</span><span class="p">,</span> <span class="n">y_ps_float2</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">y_pred_array</span><span class="p">,</span> <span class="n">y_ps_array</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pred_float1</span><span class="p">,</span> <span class="n">y_pred_array</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pred_float2</span><span class="p">,</span> <span class="n">y_pred_array</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps_float1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_ps_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps_float2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_ps_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="test_results_single_and_multi_jobs"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_results_single_and_multi_jobs">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_results_single_and_multi_jobs</span><span class="p">(</span><span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that MapieRegressor gives equal predictions</span>
<span class="sd">    regardless of number of parallel jobs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">mapie_clf_single</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf_multi</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf_single</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mapie_clf_multi</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">y_pred_single</span><span class="p">,</span> <span class="n">y_ps_single</span> <span class="o">=</span> <span class="n">mapie_clf_single</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">y_pred_multi</span><span class="p">,</span> <span class="n">y_ps_multi</span> <span class="o">=</span> <span class="n">mapie_clf_multi</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pred_single</span><span class="p">,</span> <span class="n">y_pred_multi</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps_single</span><span class="p">,</span> <span class="n">y_ps_multi</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_results_with_constant_sample_weights"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_results_with_constant_sample_weights">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_results_with_constant_sample_weights</span><span class="p">(</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test predictions when sample weights are None</span>
<span class="sd">    or constant with different values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mf">1e-99</span><span class="p">)</span>
    <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">mapie_clf0</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf1</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf2</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf0</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">mapie_clf1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n_samples</span><span class="p">))</span>
    <span class="n">mapie_clf2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">y_pred0</span><span class="p">,</span> <span class="n">y_ps0</span> <span class="o">=</span> <span class="n">mapie_clf0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">y_pred1</span><span class="p">,</span> <span class="n">y_ps1</span> <span class="o">=</span> <span class="n">mapie_clf1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">y_pred2</span><span class="p">,</span> <span class="n">y_ps2</span> <span class="o">=</span> <span class="n">mapie_clf2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pred0</span><span class="p">,</span> <span class="n">y_pred1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pred0</span><span class="p">,</span> <span class="n">y_pred2</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps0</span><span class="p">,</span> <span class="n">y_ps1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps0</span><span class="p">,</span> <span class="n">y_ps2</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_results_with_constant_groups"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_results_with_constant_groups">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_results_with_constant_groups</span><span class="p">(</span><span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test predictions when groups are None</span>
<span class="sd">    or constant with different values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mf">1e-99</span><span class="p">)</span>
    <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">mapie_clf0</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf1</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf2</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf0</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">mapie_clf1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n_samples</span><span class="p">))</span>
    <span class="n">mapie_clf2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">y_pred0</span><span class="p">,</span> <span class="n">y_ps0</span> <span class="o">=</span> <span class="n">mapie_clf0</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">y_pred1</span><span class="p">,</span> <span class="n">y_ps1</span> <span class="o">=</span> <span class="n">mapie_clf1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">y_pred2</span><span class="p">,</span> <span class="n">y_ps2</span> <span class="o">=</span> <span class="n">mapie_clf2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pred0</span><span class="p">,</span> <span class="n">y_pred1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_pred0</span><span class="p">,</span> <span class="n">y_pred2</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps0</span><span class="p">,</span> <span class="n">y_ps1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps0</span><span class="p">,</span> <span class="n">y_ps2</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_results_with_groups"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_results_with_groups">[docs]</a><span class="k">def</span> <span class="nf">test_results_with_groups</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test predictions when groups specified (not None and</span>
<span class="sd">    not constant).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">estimator</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;most_frequent&quot;</span><span class="p">)</span>

    <span class="n">strategy_no_group</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">estimator</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">strategy_group</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">estimator</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="n">GroupKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">mapie0</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">strategy_no_group</span><span class="p">)</span>
    <span class="n">mapie1</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">strategy_group</span><span class="p">)</span>
    <span class="n">mapie0</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">mapie1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>
    <span class="c1"># check class member conformity_scores_:</span>
    <span class="c1"># np.take_along_axis(1 - y_pred_proba, y_enc.reshape(-1, 1), axis=1)</span>
    <span class="c1"># cv folds with KFold:</span>
    <span class="c1"># [(array([2, 3, 4, 5]), array([0, 1])),</span>
    <span class="c1">#  (array([0, 1, 4, 5]), array([2, 3])),</span>
    <span class="c1">#  (array([0, 1, 2, 3]), array([4, 5]))]</span>
    <span class="c1"># cv folds with GroupKFold:</span>
    <span class="c1"># [(array([0, 1, 3, 4]), array([2, 5])),</span>
    <span class="c1">#  (array([0, 2, 3, 5]), array([1, 4])),</span>
    <span class="c1">#  (array([1, 2, 4, 5]), array([0, 3]))]</span>
    <span class="n">conformity_scores_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]])</span>
    <span class="n">conformity_scores_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">mapie0</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">,</span> <span class="n">conformity_scores_0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">mapie1</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">,</span> <span class="n">conformity_scores_1</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_valid_prediction"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_valid_prediction">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]),</span> <span class="kc">None</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_valid_prediction</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test fit and predict.&quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">multi_class</span><span class="o">=</span><span class="s2">&quot;multinomial&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_toy_dataset_predictions"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_toy_dataset_predictions">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_toy_dataset_predictions</span><span class="p">(</span><span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test prediction sets estimated by MapieClassifier on a toy dataset&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;aps_randomized_cv_crossval&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;split&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strategy</span><span class="p">:</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">,</span> <span class="n">size_raps</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_ps</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X_toy</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_toy_mapie</span><span class="p">[</span><span class="n">strategy</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span>
        <span class="n">classification_coverage_score</span><span class="p">(</span><span class="n">y_toy</span><span class="p">,</span> <span class="n">y_ps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span>
        <span class="n">COVERAGES</span><span class="p">[</span><span class="n">strategy</span><span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="test_toy_binary_dataset_predictions"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_toy_binary_dataset_predictions">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES_BINARY</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_toy_binary_dataset_predictions</span><span class="p">(</span><span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test prediction sets estimated by MapieClassifier on a toy binary dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">args_predict</span> <span class="o">=</span> <span class="n">STRATEGIES_BINARY</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;split&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strategy</span><span class="p">:</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy_binary</span><span class="p">,</span> <span class="n">y_toy_binary</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy_binary</span><span class="p">,</span> <span class="n">y_toy_binary</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_ps</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">X_toy</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">],</span>
        <span class="n">agg_scores</span><span class="o">=</span><span class="n">args_predict</span><span class="p">[</span><span class="s2">&quot;agg_scores&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_toy_binary_mapie</span><span class="p">[</span><span class="n">strategy</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span>
        <span class="n">classification_coverage_score</span><span class="p">(</span><span class="n">y_toy_binary</span><span class="p">,</span> <span class="n">y_ps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span>
        <span class="n">COVERAGES_BINARY</span><span class="p">[</span><span class="n">strategy</span><span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="test_cumulated_scores"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_cumulated_scores">[docs]</a><span class="k">def</span> <span class="nf">test_cumulated_scores</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test cumulated score method on a tiny dataset.&quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.65</span><span class="p">]</span>
    <span class="n">quantile</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.750183952461055</span><span class="p">]</span>
    <span class="c1"># fit</span>
    <span class="n">cumclf</span> <span class="o">=</span> <span class="n">CumulatedScoreClassifier</span><span class="p">()</span>
    <span class="n">cumclf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cumclf</span><span class="o">.</span><span class="n">X_calib</span><span class="p">,</span> <span class="n">cumclf</span><span class="o">.</span><span class="n">y_calib</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">cumclf</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cumclf</span><span class="o">.</span><span class="n">X_calib</span><span class="p">,</span> <span class="n">cumclf</span><span class="o">.</span><span class="n">y_calib</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">,</span> <span class="n">cumclf</span><span class="o">.</span><span class="n">y_calib_scores</span>
    <span class="p">)</span>
    <span class="c1"># predict</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_ps</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">cumclf</span><span class="o">.</span><span class="n">X_test</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">mapie_clf</span><span class="o">.</span><span class="n">quantiles_</span><span class="p">,</span> <span class="n">quantile</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cumclf</span><span class="o">.</span><span class="n">y_pred_sets</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_image_cumulated_scores"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_image_cumulated_scores">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">IMAGE_INPUT</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_image_cumulated_scores</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test image as input for &quot;aps&quot; method.&quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.65</span><span class="p">]</span>
    <span class="n">quantile</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.750183952461055</span><span class="p">]</span>
    <span class="c1"># fit</span>
    <span class="n">X_calib</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;X_calib&quot;</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s2">&quot;X_test&quot;</span><span class="p">]</span>
    <span class="n">cumclf</span> <span class="o">=</span> <span class="n">ImageClassifier</span><span class="p">(</span><span class="n">X_calib</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>
    <span class="n">cumclf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cumclf</span><span class="o">.</span><span class="n">X_calib</span><span class="p">,</span> <span class="n">cumclf</span><span class="o">.</span><span class="n">y_calib</span><span class="p">)</span>
    <span class="n">mapie</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">cumclf</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cumclf</span><span class="o">.</span><span class="n">X_calib</span><span class="p">,</span> <span class="n">cumclf</span><span class="o">.</span><span class="n">y_calib</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">mapie</span><span class="o">.</span><span class="n">conformity_scores_</span><span class="p">,</span> <span class="n">cumclf</span><span class="o">.</span><span class="n">y_calib_scores</span><span class="p">)</span>
    <span class="c1"># predict</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_ps</span> <span class="o">=</span> <span class="n">mapie</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">cumclf</span><span class="o">.</span><span class="n">X_test</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">mapie</span><span class="o">.</span><span class="n">quantiles_</span><span class="p">,</span> <span class="n">quantile</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">y_ps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cumclf</span><span class="o">.</span><span class="n">y_pred_sets</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_sum_proba_to_one_fit"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_sum_proba_to_one_fit">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;y_pred_proba&quot;</span><span class="p">,</span> <span class="n">Y_PRED_PROBA_WRONG</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_sum_proba_to_one_fit</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if when the output probabilities of the model do not</span>
<span class="sd">    sum to one, return an error in the fit method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrong_model</span> <span class="o">=</span> <span class="n">WrongOutputModel</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">wrong_model</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="ne">AssertionError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*The sum of the scores is not equal to one.*&quot;</span>
    <span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_sum_proba_to_one_predict"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_sum_proba_to_one_predict">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;y_pred_proba&quot;</span><span class="p">,</span> <span class="n">Y_PRED_PROBA_WRONG</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_sum_proba_to_one_predict</span><span class="p">(</span>
    <span class="n">y_pred_proba</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if when the output probabilities of the model do not</span>
<span class="sd">    sum to one, return an error in the predict method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrong_model</span> <span class="o">=</span> <span class="n">WrongOutputModel</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">single_estimator_</span> <span class="o">=</span> <span class="n">wrong_model</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="ne">AssertionError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*The sum of the scores is not equal to one.*&quot;</span>
    <span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_classifier_without_classes_attribute"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_classifier_without_classes_attribute">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;estimator&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">LogisticRegression</span><span class="p">(),</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">LogisticRegression</span><span class="p">())]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_classifier_without_classes_attribute</span><span class="p">(</span>
    <span class="n">estimator</span><span class="p">:</span> <span class="n">ClassifierMixin</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that prefitted classifier without &#39;classes_ &#39;attribute raises error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">estimator</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;classes_&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="s2">&quot;classes_&quot;</span><span class="p">)</span>
    <span class="n">mapie</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">estimator</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="ne">AttributeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*does not contain &#39;classes_&#39;.*&quot;</span>
    <span class="p">):</span>
        <span class="n">mapie</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_method_error_in_fit"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_method_error_in_fit">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="n">WRONG_METHODS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_method_error_in_fit</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test else condition for the method in .fit&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
        <span class="n">MapieClassifier</span><span class="p">,</span> <span class="s2">&quot;_check_parameters&quot;</span><span class="p">,</span> <span class="n">do_nothing</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*Invalid method.*&quot;</span><span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_method_error_in_predict"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_method_error_in_predict">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="n">WRONG_METHODS</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_method_error_in_predict</span><span class="p">(</span><span class="n">method</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test else condition for the method in .predict&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;lac&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*Invalid method.*&quot;</span><span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_include_label_error_in_predict"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_include_label_error_in_predict">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;include_labels&quot;</span><span class="p">,</span> <span class="n">WRONG_INCLUDE_LABELS</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_include_label_error_in_predict</span><span class="p">(</span>
    <span class="n">monkeypatch</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">include_labels</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test else condition for include_label parameter in .predict&quot;&quot;&quot;</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
        <span class="n">MapieClassifier</span><span class="p">,</span>
        <span class="s2">&quot;_check_include_last_label&quot;</span><span class="p">,</span>
        <span class="n">do_nothing</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*Invalid include.*&quot;</span><span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
            <span class="n">X_toy</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">include_last_label</span><span class="o">=</span><span class="n">include_labels</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="test_pred_loof_isnan"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_pred_loof_isnan">[docs]</a><span class="k">def</span> <span class="nf">test_pred_loof_isnan</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test that if validation set is empty then prediction is empty.&quot;&quot;&quot;</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">_fit_and_predict_oof_model</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(),</span>
        <span class="n">X</span><span class="o">=</span><span class="n">X_toy</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y_toy</span><span class="p">,</span>
        <span class="n">train_index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
        <span class="n">val_index</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="test_pipeline_compatibility"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_pipeline_compatibility">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_pipeline_compatibility</span><span class="p">(</span><span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check that MAPIE works on pipeline based on pandas dataframes&quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;x_cat&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">],</span>
            <span class="s2">&quot;x_num&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">numeric_preprocessor</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;imputer&quot;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">categorical_preprocessor</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">))</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="n">categorical_preprocessor</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x_cat&quot;</span><span class="p">]),</span>
            <span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="n">numeric_preprocessor</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;x_num&quot;</span><span class="p">])</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">())</span>
    <span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mapie</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipe</span><span class="p">,</span> <span class="o">**</span><span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mapie</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mapie</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_pred_proba_float64"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_pred_proba_float64">[docs]</a><span class="k">def</span> <span class="nf">test_pred_proba_float64</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check that the method _check_proba_normalized returns float64.&quot;&quot;&quot;</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">sum_of_rows</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">normalized_array</span> <span class="o">=</span> <span class="n">y_pred_proba</span> <span class="o">/</span> <span class="n">sum_of_rows</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">mapie</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">checked_normalized_array</span> <span class="o">=</span> <span class="n">mapie</span><span class="o">.</span><span class="n">_check_proba_normalized</span><span class="p">(</span><span class="n">normalized_array</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">checked_normalized_array</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float64&quot;</span></div>


<div class="viewcode-block" id="test_classif_float32"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_classif_float32">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_classif_float32</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that by returning float64 arrays there are not</span>
<span class="sd">    empty predictions sets with naive method using both</span>
<span class="sd">    prefit and cv=5. If the y_pred_proba was still in</span>
<span class="sd">    float32, as the quantile=0.90 would have been equal</span>
<span class="sd">    to the highest probability, MAPIE would have return</span>
<span class="sd">    empty prediction sets&quot;&quot;&quot;</span>
    <span class="n">X_cal</span><span class="p">,</span> <span class="n">y_cal</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">n_redundant</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">n_informative</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">)</span>
    <span class="n">X_test</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
        <span class="n">n_samples</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">n_redundant</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">n_informative</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">.9</span>
    <span class="n">dummy_classif</span> <span class="o">=</span> <span class="n">Float32OuputModel</span><span class="p">()</span>

    <span class="n">mapie</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">dummy_classif</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;naive&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_cal</span><span class="p">,</span> <span class="n">y_cal</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">yps</span> <span class="o">=</span> <span class="n">mapie</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">include_last_label</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]],</span> <span class="mi">20</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">==</span> <span class="n">yps</span>
    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>


<div class="viewcode-block" id="test_regularize_conf_scores_shape"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_regularize_conf_scores_shape">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;k_lambda&quot;</span><span class="p">,</span> <span class="n">REGULARIZATION_PARAMETERS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_regularize_conf_scores_shape</span><span class="p">(</span><span class="n">k_lambda</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the conformity scores have the correct shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lambda_</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k_lambda</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k_lambda</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">args_init</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="s2">&quot;raps&quot;</span><span class="p">]</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="o">**</span><span class="n">args_init</span><span class="p">)</span>
    <span class="n">conf_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">conf_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">reg_conf_scores</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">_regularize_conformity_score</span><span class="p">(</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">lambda_</span><span class="p">,</span> <span class="n">conf_scores</span><span class="p">,</span> <span class="n">cutoff</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">reg_conf_scores</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">))</span></div>


<div class="viewcode-block" id="test_get_true_label_cumsum_proba_shape"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_get_true_label_cumsum_proba_shape">[docs]</a><span class="k">def</span> <span class="nf">test_get_true_label_cumsum_proba_shape</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the true label cumsumed probabilities</span>
<span class="sd">    have the correct shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">cumsum_proba</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">_get_true_label_cumsum_proba</span><span class="p">(</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">cumsum_proba</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">cutoff</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="p">)</span></div>


<div class="viewcode-block" id="test_get_true_label_cumsum_proba_result"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_get_true_label_cumsum_proba_result">[docs]</a><span class="k">def</span> <span class="nf">test_get_true_label_cumsum_proba_result</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the true label cumsumed probabilities</span>
<span class="sd">    are the expected ones.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">cumsum_proba</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">_get_true_label_cumsum_proba</span><span class="p">(</span>
        <span class="n">y_toy</span><span class="p">,</span> <span class="n">y_pred</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span>
        <span class="n">cumsum_proba</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">y_pred</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">y_pred</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">y_pred</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">y_pred</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">y_pred</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">y_pred</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_allclose</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span></div>


<div class="viewcode-block" id="test_get_last_included_proba_shape"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_get_last_included_proba_shape">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;k_lambda&quot;</span><span class="p">,</span> <span class="n">REGULARIZATION_PARAMETERS</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="p">[</span><span class="o">*</span><span class="n">STRATEGIES</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_get_last_included_proba_shape</span><span class="p">(</span><span class="n">k_lambda</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the outputs of _get_last_included_proba method</span>
<span class="sd">    have the correct shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lambda_</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k_lambda</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k_lambda</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="mf">.2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">thresholds</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">check_alpha</span><span class="p">(</span><span class="n">thresholds</span><span class="p">))</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
        <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>

    <span class="n">mapie</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="o">**</span><span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">include_last_label</span> <span class="o">=</span> <span class="n">STRATEGIES</span><span class="p">[</span><span class="n">strategy</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;include_last_label&quot;</span><span class="p">]</span>
    <span class="n">y_p_p_c</span><span class="p">,</span> <span class="n">y_p_i_l</span><span class="p">,</span> <span class="n">y_p_p_i_l</span> <span class="o">=</span> <span class="n">mapie</span><span class="o">.</span><span class="n">_get_last_included_proba</span><span class="p">(</span>
        <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">,</span>
        <span class="n">include_last_label</span><span class="p">,</span> <span class="n">lambda_</span><span class="p">,</span> <span class="n">k</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">y_p_p_c</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">y_p_i_l</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">y_p_p_i_l</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="p">))</span></div>


<div class="viewcode-block" id="test_get_true_label_position"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_get_true_label_position">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;y_true_proba_place&quot;</span><span class="p">,</span> <span class="n">Y_TRUE_PROBA_PLACE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_true_label_position</span><span class="p">(</span>
    <span class="n">y_true_proba_place</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">NDArray</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that the returned true label position the good.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">y_true_proba_place</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">y_true_proba_place</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">place</span> <span class="o">=</span> <span class="n">y_true_proba_place</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">mapie</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">found_place</span> <span class="o">=</span> <span class="n">mapie</span><span class="o">.</span><span class="n">_get_true_label_position</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">y_true</span><span class="p">)</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">found_place</span> <span class="o">==</span> <span class="n">place</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>


<div class="viewcode-block" id="test_error_raps_cv_not_prefit"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_error_raps_cv_not_prefit">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_error_raps_cv_not_prefit</span><span class="p">(</span><span class="n">cv</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that an error is raised if the method is RAPS</span>
<span class="sd">    and cv is different from prefit and split.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mapie</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;raps&quot;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*RAPS method can only.*&quot;</span><span class="p">):</span>
        <span class="n">mapie</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_not_all_label_in_calib"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_not_all_label_in_calib">[docs]</a><span class="k">def</span> <span class="nf">test_not_all_label_in_calib</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the true label cumsumed probabilities</span>
<span class="sd">    have the correct shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">indices_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">X_mapie</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">y_mapie</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_mapie</span><span class="p">,</span> <span class="n">y_mapie</span><span class="p">)</span>
    <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_pss</span> <span class="o">=</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="p">)</span>
    <span class="k">assert</span> <span class="n">y_pss</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_warning_not_all_label_in_calib"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_warning_not_all_label_in_calib">[docs]</a><span class="k">def</span> <span class="nf">test_warning_not_all_label_in_calib</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that a warning is raised y is binary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">indices_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">X_mapie</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">y_mapie</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span>
        <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*WARNING: your calibration dataset.*&quot;</span>
    <span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_mapie</span><span class="p">,</span> <span class="n">y_mapie</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_n_classes_prefit"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_n_classes_prefit">[docs]</a><span class="k">def</span> <span class="nf">test_n_classes_prefit</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the attribute n_classes_ has the correct</span>
<span class="sd">    value with cv=&quot;prefit&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">indices_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">X_mapie</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">y_mapie</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_mapie</span><span class="p">,</span> <span class="n">y_mapie</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">n_classes_</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span></div>


<div class="viewcode-block" id="test_classes_prefit"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_classes_prefit">[docs]</a><span class="k">def</span> <span class="nf">test_classes_prefit</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the attribute classes_ has the correct</span>
<span class="sd">    value with cv=&quot;prefit&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">indices_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">X_mapie</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">y_mapie</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_mapie</span><span class="p">,</span> <span class="n">y_mapie</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">mapie_clf</span><span class="o">.</span><span class="n">classes_</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>


<div class="viewcode-block" id="test_classes_encoder_same_than_model"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_classes_encoder_same_than_model">[docs]</a><span class="k">def</span> <span class="nf">test_classes_encoder_same_than_model</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the attribute label encoder has the same</span>
<span class="sd">    classes as the prefit model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">indices_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">X_mapie</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">y_mapie</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">indices_remove</span><span class="p">]</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_mapie</span><span class="p">,</span> <span class="n">y_mapie</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">mapie_clf</span><span class="o">.</span><span class="n">label_encoder_</span><span class="o">.</span><span class="n">classes_</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>


<div class="viewcode-block" id="test_n_classes_cv"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_n_classes_cv">[docs]</a><span class="k">def</span> <span class="nf">test_n_classes_cv</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the attribute n_classes_ has the correct</span>
<span class="sd">    value with cross_validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>

    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">mapie_clf</span><span class="o">.</span><span class="n">n_classes_</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span></div>


<div class="viewcode-block" id="test_classes_cv"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_classes_cv">[docs]</a><span class="k">def</span> <span class="nf">test_classes_cv</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the attribute classes_ has the correct</span>
<span class="sd">    value with cross_validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>

    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">mapie_clf</span><span class="o">.</span><span class="n">classes_</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>


<div class="viewcode-block" id="test_raise_error_new_class"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_raise_error_new_class">[docs]</a><span class="k">def</span> <span class="nf">test_raise_error_new_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the attribute if there is an unseen</span>
<span class="sd">    classe in `y` then an error is raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span>
        <span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*Values in y do not matched values.*&quot;</span>
    <span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_deprecated_method_warning"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_deprecated_method_warning">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulated_score&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_deprecated_method_warning</span><span class="p">(</span><span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that a warning is raised if choose a deprecated method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span>
    <span class="n">mapie_clf</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="s2">&quot;prefit&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*WARNING: Deprecated method.*&quot;</span>
    <span class="p">):</span>
        <span class="n">mapie_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_toy</span><span class="p">,</span> <span class="n">y_toy</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_fit_parameters_passing"><a class="viewcode-back" href="../../../src/prom.tests.html#prom.tests.test_classification.test_fit_parameters_passing">[docs]</a><span class="k">def</span> <span class="nf">test_fit_parameters_passing</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test passing fit parameters, here early stopping at iteration 3.</span>
<span class="sd">    Checks that underlying GradientBoosting estimators have used 3 iterations</span>
<span class="sd">    only during boosting, instead of default value for n_estimators (=100).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gb</span> <span class="o">=</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>

    <span class="n">mapie</span> <span class="o">=</span> <span class="n">MapieClassifier</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">gb</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;aps&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">early_stopping_monitor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">est</span><span class="p">,</span> <span class="nb">locals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True on the 3rd iteration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="n">mapie</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="n">early_stopping_monitor</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">mapie</span><span class="o">.</span><span class="n">single_estimator_</span><span class="o">.</span><span class="n">estimators_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="k">for</span> <span class="n">estimator</span> <span class="ow">in</span> <span class="n">mapie</span><span class="o">.</span><span class="n">estimators_</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">estimator</span><span class="o">.</span><span class="n">estimators_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, _.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>