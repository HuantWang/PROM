<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VD_vulde &mdash; Prom v0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Prom
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../src/prom.html">prom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../src/prom.conformity_scores.html">prom.conformity_scores package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../src/prom.control_risk.html">prom.control_risk package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../src/prom.estimator.html">prom.estimator package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../src/prom.regression.html">prom.regression package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Thread Coarsening API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../case_study/thread/Deeptune_utils.html">Deeptune_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/thread/Magni_utils.html">Magni_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/thread/Thread_Deep.html">Thread_Deep module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/thread/Thread_magni.html">Thread_magni module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Loop Tiling API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../case_study/Loop/Deeptune_utils.html">Deeptune_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/Loop/Loop_de.html">Loop_de module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/Loop/Loop_ma.html">Loop_ma module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/Loop/Loop_SVM.html">Loop_SVM module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/Loop/Loop_thread_sensitive.html">Loop_thread_sensitive module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/Loop/Magni_utils.html">Magni_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/Loop/Ml_utils.html">Ml_utils module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/Loop/prom_util_sensitive.html">prom_util_sensitive module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Device Mapping API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../case_study/DeviceM/compy.models.graphs.html">compy.models.graphs package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/DeviceM/compy.models.seqs.html">compy.models.seqs package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/DeviceM/compy.representations.html">compy.representations package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bug Detection API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../case_study/BugD/model.html">model module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/BugD/preprocess.html">preprocess module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/BugD/VD_codebert.html">VD_codebert module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/BugD/VD_vulde.html">VD_vulde module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tensor Tuning API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../case_study/tlp/bert_large.html">bert_large module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/tlp/bert_med.html">bert_med module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/tlp/bert_tiny.html">bert_tiny module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/tlp/sensitive.html">sensitive module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/tlp/tlp_fine_tune.html">tlp_fine_tune module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../case_study/tlp/train_tlp.html">train_tlp module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Prom</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">VD_vulde</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for VD_vulde</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">nni</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">Bug_detection</span>
<span class="kn">from</span> <span class="nn">preprocess</span> <span class="kn">import</span> <span class="n">pre</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">SequentialSampler</span><span class="p">,</span> <span class="n">RandomSampler</span><span class="p">,</span> <span class="n">TensorDataset</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.distributed</span> <span class="kn">import</span> <span class="n">DistributedSampler</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">sklearn.naive_bayes</span> <span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CURL_CA_BUNDLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="c1"># sys.path.append(&#39;./case_study/DeviceM&#39;)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./case_study/BugD&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/cgo/prom/PROM&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/cgo/prom/PROM/thirdpackage&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/cgo/prom/PROM/src&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">transformers_logging</span>

<span class="c1"># 设置Transformers库的日志级别为ERROR，只显示错误信息</span>
<span class="n">transformers_logging</span><span class="o">.</span><span class="n">set_verbosity_error</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">prom.prom_classification</span> <span class="kn">import</span> <span class="n">MapieClassifier</span>
<span class="kn">from</span> <span class="nn">prom.metrics</span> <span class="kn">import</span> <span class="p">(</span><span class="n">classification_coverage_score</span><span class="p">,</span>
                           <span class="n">classification_mean_width_score</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">src.prom.prom_util</span> <span class="kn">import</span> <span class="n">Prom_utils</span>
<span class="c1"># try:</span>
<span class="c1">#     from torch.utils.tensorboard import SummaryWriter</span>
<span class="c1"># except:</span>
<span class="c1">#     from tensorboardX import SummaryWriter</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">BiLSTMModel</span>

<span class="n">cpu_cont</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">WEIGHTS_NAME</span><span class="p">,</span> <span class="n">AdamW</span><span class="p">,</span> <span class="n">get_linear_schedule_with_warmup</span><span class="p">,</span>
                          <span class="n">BertConfig</span><span class="p">,</span> <span class="n">BertForMaskedLM</span><span class="p">,</span> <span class="n">BertTokenizer</span><span class="p">,</span>
    <span class="c1"># GPT2Config, GPT2LMHeadModel, GPT2Tokenizer,</span>
                          <span class="n">OpenAIGPTConfig</span><span class="p">,</span> <span class="n">OpenAIGPTLMHeadModel</span><span class="p">,</span> <span class="n">OpenAIGPTTokenizer</span><span class="p">,</span>
                          <span class="n">RobertaConfig</span><span class="p">,</span> <span class="n">RobertaForSequenceClassification</span><span class="p">,</span> <span class="n">RobertaTokenizer</span><span class="p">,</span>
                          <span class="n">DistilBertConfig</span><span class="p">,</span> <span class="n">DistilBertForMaskedLM</span><span class="p">,</span> <span class="n">DistilBertTokenizer</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>  <span class="c1"># 只显示 ERROR 及以上级别的日志消息</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">MODEL_CLASSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># &#39;gpt2&#39;: (GPT2Config, GPT2LMHeadModel, GPT2Tokenizer),</span>
    <span class="c1"># &#39;openai-gpt&#39;: (OpenAIGPTConfig, OpenAIGPTLMHeadModel, OpenAIGPTTokenizer),</span>
    <span class="s1">&#39;bert&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">BertConfig</span><span class="p">,</span> <span class="n">BertForMaskedLM</span><span class="p">,</span> <span class="n">BertTokenizer</span><span class="p">),</span>
    <span class="s1">&#39;roberta&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">RobertaConfig</span><span class="p">,</span> <span class="n">RobertaForSequenceClassification</span><span class="p">,</span> <span class="n">RobertaTokenizer</span><span class="p">),</span>
    <span class="s1">&#39;distilbert&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">DistilBertConfig</span><span class="p">,</span> <span class="n">DistilBertForMaskedLM</span><span class="p">,</span> <span class="n">DistilBertTokenizer</span><span class="p">)</span>
<span class="p">}</span>


<div class="viewcode-block" id="InputFeatures"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.InputFeatures">[docs]</a><span class="k">class</span> <span class="nc">InputFeatures</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train the model incrementally with additional dataset samples.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser containing model configuration.</span>
<span class="sd">    train_dataset : TextDataset</span>
<span class="sd">        Dataset for training.</span>
<span class="sd">    model : object</span>
<span class="sd">        Model to be trained.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance for data processing.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Best accuracy achieved during training.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">input_tokens</span><span class="p">,</span>
                 <span class="n">input_ids</span><span class="p">,</span>
                 <span class="n">idx</span><span class="p">,</span>
                 <span class="n">label</span><span class="p">,</span>

                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_tokens</span> <span class="o">=</span> <span class="n">input_tokens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_ids</span> <span class="o">=</span> <span class="n">input_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span></div>


<span class="kn">import</span> <span class="nn">random</span>


<div class="viewcode-block" id="cvconvert_examples_to_features"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.cvconvert_examples_to_features">[docs]</a><span class="k">def</span> <span class="nf">cvconvert_examples_to_features</span><span class="p">(</span><span class="n">code_new</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert input text and label into features using a tokenizer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    code_new : str</span>
<span class="sd">        The input code to be tokenized.</span>
<span class="sd">    label : list</span>
<span class="sd">        The label corresponding to the input code.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance to tokenize the input code.</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Arguments including block size and other configurations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    InputFeatures</span>
<span class="sd">        Features containing tokenized data, token IDs, and labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># source</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_new</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">code_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">code</span><span class="p">)[:</span><span class="n">args</span><span class="o">.</span><span class="n">block_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">source_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">cls_token</span><span class="p">]</span> <span class="o">+</span> <span class="n">code_tokens</span> <span class="o">+</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">sep_token</span><span class="p">]</span>
    <span class="n">source_ids</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_tokens_to_ids</span><span class="p">(</span><span class="n">source_tokens</span><span class="p">)</span>
    <span class="n">padding_length</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">block_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_ids</span><span class="p">)</span>
    <span class="n">source_ids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">padding_length</span>
    <span class="k">return</span> <span class="n">InputFeatures</span><span class="p">(</span><span class="n">source_tokens</span><span class="p">,</span> <span class="n">source_ids</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span></div>


<span class="kn">import</span> <span class="nn">os</span>


<div class="viewcode-block" id="TextDataset"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.TextDataset">[docs]</a><span class="k">class</span> <span class="nc">TextDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dataset for loading and processing textual data for training or evaluation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance for processing text data.</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Arguments including configurations for processing the dataset.</span>
<span class="sd">    file_path : str</span>
<span class="sd">        Path to the dataset file.</span>
<span class="sd">    one_hot_vectors : list</span>
<span class="sd">        List of one-hot encoded vectors for labels.</span>
<span class="sd">    suffixes : list</span>
<span class="sd">        List of suffixes for label categorization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">one_hot_vectors</span><span class="o">=</span><span class="p">[],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">[]):</span>
        <span class="c1">#</span>
        <span class="c1"># 提取所有不同的后缀</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">examples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">:</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="c1"># pon=line.split(&#39;/&#39;)[-2]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">gap</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
                <span class="n">Graph_length</span> <span class="o">=</span> <span class="mi">50</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>

                <span class="n">X_Code_Single</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">X_Graph_Single</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">Graph_length</span><span class="p">,</span> <span class="n">Graph_length</span><span class="p">])</span>
                <span class="n">X_trace_Single</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">X_testcase_single</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">X_Node_Singe</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">X_dynamic_single</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># a=line.split(&#39;\n&#39;)[0].split(&#39;&quot;&#39;)[1]</span>
                <span class="c1"># try:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----label-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----code-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;code&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----children-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;children&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----nextToken-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;nextToken&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----computeFrom-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;computeFrom&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----guardedBy-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;guardedBy&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----guardedByNegation-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;guardedByNegation&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----lastLexicalUse-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;lastLexicalUse&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----jump-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;jump&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;=======testcase========</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;testcase&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;=========trace=========</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;trace&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="p">(</span>
                                <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----attribute-----</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;----------------dynamic----------------</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">):</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;next&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;-----ast_node-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="s2">&quot;ast_node&quot;</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;=======================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;next&quot;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span>
                            <span class="n">y</span> <span class="o">=</span> <span class="n">one_hot_vectors</span><span class="p">[</span><span class="n">suffixes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">type</span><span class="p">)]</span>
                            <span class="c1"># y = line.split()</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
                            <span class="n">X_Code_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">X_Code_Single</span> <span class="o">=</span> <span class="n">X_Code_Single</span> <span class="o">+</span> <span class="p">[</span><span class="n">X_Code_line</span><span class="p">]</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;children&quot;</span><span class="p">:</span>
                            <span class="n">num_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">num_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">num_2</span> <span class="o">&lt;</span> <span class="n">Graph_length</span> <span class="ow">and</span> <span class="n">num_1</span> <span class="o">&lt;</span> <span class="n">Graph_length</span><span class="p">:</span>
                                <span class="n">X_Graph_Single</span><span class="p">[</span><span class="n">num_1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;nextToken&quot;</span><span class="p">:</span>
                            <span class="n">num_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">num_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">X_Graph_Single</span><span class="p">[</span><span class="n">num_1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;computeFrom&quot;</span><span class="p">:</span>
                            <span class="n">num_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">num_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">num_2</span> <span class="o">&lt;</span> <span class="n">Graph_length</span> <span class="ow">and</span> <span class="n">num_1</span> <span class="o">&lt;</span> <span class="n">Graph_length</span><span class="p">:</span>
                                <span class="n">X_Graph_Single</span><span class="p">[</span><span class="n">num_1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;guardedBy&quot;</span><span class="p">:</span>
                            <span class="n">num_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">num_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">num_2</span> <span class="o">&lt;</span> <span class="n">Graph_length</span> <span class="ow">and</span> <span class="n">num_1</span> <span class="o">&lt;</span> <span class="n">Graph_length</span><span class="p">:</span>
                                <span class="n">X_Graph_Single</span><span class="p">[</span><span class="n">num_1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;guardedByNegation&quot;</span><span class="p">:</span>
                            <span class="n">num_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">num_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">num_2</span> <span class="o">&lt;</span> <span class="n">Graph_length</span> <span class="ow">and</span> <span class="n">num_1</span> <span class="o">&lt;</span> <span class="n">Graph_length</span><span class="p">:</span>
                                <span class="n">X_Graph_Single</span><span class="p">[</span><span class="n">num_1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;lastLexicalUse&quot;</span><span class="p">:</span>
                            <span class="n">num_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">num_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">num_2</span> <span class="o">&lt;</span> <span class="n">Graph_length</span> <span class="ow">and</span> <span class="n">num_1</span> <span class="o">&lt;</span> <span class="n">Graph_length</span><span class="p">:</span>
                                <span class="n">X_Graph_Single</span><span class="p">[</span><span class="n">num_1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;jump&quot;</span><span class="p">:</span>
                            <span class="n">num_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">num_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">num_2</span> <span class="o">&lt;</span> <span class="n">Graph_length</span> <span class="ow">and</span> <span class="n">num_1</span> <span class="o">&lt;</span> <span class="n">Graph_length</span><span class="p">:</span>
                                <span class="n">X_Graph_Single</span><span class="p">[</span><span class="n">num_1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;ast_node&quot;</span><span class="p">:</span>
                            <span class="n">X_Code_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">X_Node_Singe</span> <span class="o">=</span> <span class="n">X_Node_Singe</span> <span class="o">+</span> <span class="p">[</span><span class="n">X_Code_line</span><span class="p">]</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;testcase&quot;</span><span class="p">:</span>
                            <span class="n">X_Code_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">X_testcase_single</span> <span class="o">=</span> <span class="n">X_testcase_single</span> <span class="o">+</span> <span class="p">[</span><span class="n">X_Code_line</span><span class="p">]</span>
                            <span class="n">X_dynamic_single</span> <span class="o">=</span> <span class="n">X_dynamic_single</span> <span class="o">+</span> <span class="p">[</span><span class="n">X_Code_line</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;trace&quot;</span><span class="p">:</span>
                            <span class="n">X_Code_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">X_trace_Single</span> <span class="o">=</span> <span class="n">X_trace_Single</span> <span class="o">+</span> <span class="p">[</span><span class="n">X_Code_line</span><span class="p">]</span>
                            <span class="n">X_dynamic_single</span> <span class="o">=</span> <span class="n">X_dynamic_single</span> <span class="o">+</span> <span class="p">[</span><span class="n">X_Code_line</span><span class="p">]</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;please delete the file &quot;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">cvconvert_examples_to_features</span><span class="p">(</span><span class="n">gap</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">X_Code_Single</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">input_ids</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_duplicates_and_preserve_order"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.remove_duplicates_and_preserve_order">[docs]</a><span class="k">def</span> <span class="nf">remove_duplicates_and_preserve_order</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove duplicate elements from a list while preserving the order.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr : list</span>
<span class="sd">        List from which duplicates need to be removed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List with duplicates removed, preserving the original order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unique_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_elements</span><span class="p">:</span>
            <span class="n">unique_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unique_elements</span></div>


<div class="viewcode-block" id="onehot"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.onehot">[docs]</a><span class="k">def</span> <span class="nf">onehot</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate one-hot encoded vectors for categorical labels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_path : str</span>
<span class="sd">        Path to the dataset file containing label information.</span>
<span class="sd">    seed : int</span>
<span class="sd">        Random seed for reproducibility.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple containing one-hot encoded vectors and list of suffixes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">type_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">type_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="n">suffixes</span> <span class="o">=</span> <span class="n">remove_duplicates_and_preserve_order</span><span class="p">(</span><span class="n">type_all</span><span class="p">)</span>
    <span class="c1"># suffixes = list(set(type_all))</span>
    <span class="c1"># 创建独立的 One-Hot 向量</span>

    <span class="n">one_hot_vectors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
        <span class="n">one_hot</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">suffixes</span><span class="p">)</span>
        <span class="n">one_hot</span><span class="p">[</span><span class="n">suffixes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">one_hot_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_hot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">suffixes</span></div>


<div class="viewcode-block" id="set_seed"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.set_seed">[docs]</a><span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the random seed for reproducibility across NumPy, PyTorch, and Python.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seed : int</span>
<span class="sd">        The random seed for reproducibility.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="c1"># print(seed)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYHTONHASHSEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="incre"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.incre">[docs]</a><span class="k">def</span> <span class="nf">incre</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train the model incrementally with additional dataset samples.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser containing model configuration.</span>
<span class="sd">    train_dataset : TextDataset</span>
<span class="sd">        Dataset for training.</span>
<span class="sd">    model : object</span>
<span class="sd">        Model to be trained.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance for data processing.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Best accuracy achieved during training.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">per_gpu_train_batch_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span><span class="p">)</span>
    <span class="n">train_sampler</span> <span class="o">=</span> <span class="n">RandomSampler</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">DistributedSampler</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>

    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">train_sampler</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">max_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">warmup_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">logging_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span>
    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># Prepare optimizer and schedule (linear warmup and decay)</span>
    <span class="n">no_decay</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;LayerNorm.weight&#39;</span><span class="p">]</span>
    <span class="n">optimizer_grouped_parameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span>
         <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span> <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">(</span><span class="n">optimizer_grouped_parameters</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">get_linear_schedule_with_warmup</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_steps</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                                                <span class="n">num_training_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_steps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fp16</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">apex</span> <span class="kn">import</span> <span class="n">amp</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Please install apex from https://www.github.com/nvidia/apex to use fp16 training.&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">opt_level</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">fp16_opt_level</span><span class="p">)</span>

    <span class="c1"># multi-gpu training (should be after apex fp16 initialization)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Distributed training (should be after apex fp16 initialization)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">DistributedDataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">],</span>
                                                          <span class="n">output_device</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">,</span>
                                                          <span class="n">find_unused_parameters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">checkpoint_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;checkpoint-last&#39;</span><span class="p">)</span>
    <span class="n">scheduler_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;scheduler.pt&#39;</span><span class="p">)</span>
    <span class="n">optimizer_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;optimizer.pt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">scheduler_last</span><span class="p">):</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">scheduler_last</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">optimizer_last</span><span class="p">):</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">optimizer_last</span><span class="p">))</span>
    <span class="c1"># Train!</span>
    <span class="c1"># logger.info(&quot;***** Running training *****&quot;)</span>
    <span class="c1"># logger.info(&quot;  Num examples = %d&quot;, len(train_dataset))</span>
    <span class="c1"># logger.info(&quot;  Num Epochs = %d&quot;, args.num_train_epochs)</span>
    <span class="c1"># logger.info(&quot;  Instantaneous batch size per GPU = %d&quot;, args.per_gpu_train_batch_size)</span>
    <span class="c1"># logger.info(&quot;  Total train batch size (w. parallel, distributed &amp; accumulation) = %d&quot;,</span>
    <span class="c1">#             args.train_batch_size * args.gradient_accumulation_steps * (</span>
    <span class="c1">#                 torch.distributed.get_world_size() if args.local_rank != -1 else 1))</span>
    <span class="c1"># logger.info(&quot;  Gradient Accumulation steps = %d&quot;, args.gradient_accumulation_steps)</span>
    <span class="c1"># logger.info(&quot;  Total optimization steps = %d&quot;, args.max_steps)</span>

    <span class="n">global_step</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">start_step</span>
    <span class="n">tr_loss</span><span class="p">,</span> <span class="n">logging_loss</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">tr_nb</span><span class="p">,</span> <span class="n">tr_num</span><span class="p">,</span> <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">best_mrr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">best_f1</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">best_f1_uq</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">best_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># model.resize_token_embeddings(len(tokenizer))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span><span class="p">)):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">),</span><span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tr_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>

            <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># mean() to average on multi-gpu parallel training</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fp16</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">amp</span><span class="o">.</span><span class="n">scale_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span> <span class="k">as</span> <span class="n">scaled_loss</span><span class="p">:</span>
                    <span class="n">scaled_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">amp</span><span class="o">.</span><span class="n">master_params</span><span class="p">(</span><span class="n">optimizer</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">)</span>

            <span class="n">tr_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">tr_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">tr_loss</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">train_loss</span> <span class="o">/</span> <span class="n">tr_num</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;epoch </span><span class="si">{}</span><span class="s2"> loss </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">output_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">tr_loss</span> <span class="o">-</span> <span class="n">logging_loss</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">global_step</span> <span class="o">-</span> <span class="n">tr_nb</span><span class="p">)),</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">logging_steps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">logging_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging_loss</span> <span class="o">=</span> <span class="n">tr_loss</span>
                    <span class="n">tr_nb</span> <span class="o">=</span> <span class="n">global_step</span>

                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">evaluate_during_training</span><span class="p">:</span>  <span class="c1"># Only evaluate when single GPU otherwise metrics may not average well</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate_test</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">eval_when_training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                            <span class="c1"># Save model checkpoint</span>
                        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;test_acc&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_acc</span><span class="p">:</span>
                            <span class="n">best_acc</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;test_acc&#39;</span><span class="p">]</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Best acc:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;test_acc&#39;</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best_acc</span></div>

<div class="viewcode-block" id="train"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.train">[docs]</a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Train the model on the training dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser containing model configuration.</span>
<span class="sd">    train_dataset : TextDataset</span>
<span class="sd">        Dataset for training.</span>
<span class="sd">    model : object</span>
<span class="sd">        Model to be trained.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance for data processing.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Best F1 score achieved during training.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">per_gpu_train_batch_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span><span class="p">)</span>
    <span class="n">train_sampler</span> <span class="o">=</span> <span class="n">RandomSampler</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">DistributedSampler</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>

    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">train_sampler</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">max_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">warmup_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">logging_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span>
    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># Prepare optimizer and schedule (linear warmup and decay)</span>
    <span class="n">no_decay</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;LayerNorm.weight&#39;</span><span class="p">]</span>
    <span class="n">optimizer_grouped_parameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span>
         <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span> <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">(</span><span class="n">optimizer_grouped_parameters</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">get_linear_schedule_with_warmup</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_steps</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                                                <span class="n">num_training_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_steps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fp16</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">apex</span> <span class="kn">import</span> <span class="n">amp</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Please install apex from https://www.github.com/nvidia/apex to use fp16 training.&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">opt_level</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">fp16_opt_level</span><span class="p">)</span>

    <span class="c1"># multi-gpu training (should be after apex fp16 initialization)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Distributed training (should be after apex fp16 initialization)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">DistributedDataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">],</span>
                                                          <span class="n">output_device</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">,</span>
                                                          <span class="n">find_unused_parameters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">checkpoint_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;checkpoint-last&#39;</span><span class="p">)</span>
    <span class="n">scheduler_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;scheduler.pt&#39;</span><span class="p">)</span>
    <span class="n">optimizer_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;optimizer.pt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">scheduler_last</span><span class="p">):</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">scheduler_last</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">optimizer_last</span><span class="p">):</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">optimizer_last</span><span class="p">))</span>
    <span class="c1"># Train!</span>
    <span class="c1"># logger.info(&quot;***** Running training *****&quot;)</span>
    <span class="c1"># logger.info(&quot;  Num examples = %d&quot;, len(train_dataset))</span>
    <span class="c1"># logger.info(&quot;  Num Epochs = %d&quot;, args.num_train_epochs)</span>
    <span class="c1"># logger.info(&quot;  Instantaneous batch size per GPU = %d&quot;, args.per_gpu_train_batch_size)</span>
    <span class="c1"># logger.info(&quot;  Total train batch size (w. parallel, distributed &amp; accumulation) = %d&quot;,</span>
    <span class="c1">#             args.train_batch_size * args.gradient_accumulation_steps * (</span>
    <span class="c1">#                 torch.distributed.get_world_size() if args.local_rank != -1 else 1))</span>
    <span class="c1"># logger.info(&quot;  Gradient Accumulation steps = %d&quot;, args.gradient_accumulation_steps)</span>
    <span class="c1"># logger.info(&quot;  Total optimization steps = %d&quot;, args.max_steps)</span>

    <span class="n">global_step</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">start_step</span>
    <span class="n">tr_loss</span><span class="p">,</span> <span class="n">logging_loss</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">tr_nb</span><span class="p">,</span> <span class="n">tr_num</span><span class="p">,</span> <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">best_mrr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">best_f1</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">best_f1_uq</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">best_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">increment_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># model.resize_token_embeddings(len(tokenizer))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span><span class="p">)):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">),</span><span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tr_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>

            <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># mean() to average on multi-gpu parallel training</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fp16</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">amp</span><span class="o">.</span><span class="n">scale_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span> <span class="k">as</span> <span class="n">scaled_loss</span><span class="p">:</span>
                    <span class="n">scaled_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">amp</span><span class="o">.</span><span class="n">master_params</span><span class="p">(</span><span class="n">optimizer</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">)</span>

            <span class="n">tr_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">tr_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">tr_loss</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">train_loss</span> <span class="o">/</span> <span class="n">tr_num</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;epoch </span><span class="si">{}</span><span class="s2"> loss </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">output_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">tr_loss</span> <span class="o">-</span> <span class="n">logging_loss</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">global_step</span> <span class="o">-</span> <span class="n">tr_nb</span><span class="p">)),</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">logging_steps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">logging_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging_loss</span> <span class="o">=</span> <span class="n">tr_loss</span>
                    <span class="n">tr_nb</span> <span class="o">=</span> <span class="n">global_step</span>

                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">evaluate_during_training</span><span class="p">:</span>  <span class="c1"># Only evaluate when single GPU otherwise metrics may not average well</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">eval_when_training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># print(&quot;eval results:&quot;, results)</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                            <span class="c1"># Save model checkpoint</span>
                        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval_acc&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_f1</span><span class="p">:</span>
                            <span class="n">best_f1</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval_acc&#39;</span><span class="p">]</span>
                            <span class="c1"># logger.info(&quot;  &quot; + &quot;*&quot; * 20)</span>
                            <span class="c1"># logger.info(&quot;  Best f1:%s&quot;, round(best_f1, 4))</span>
                            <span class="c1"># logger.info(&quot;  Best pre:%s&quot;, round(results[&#39;eval_pre&#39;], 4))</span>
                            <span class="c1"># logger.info(&quot;  Best rec:%s&quot;, round(results[&#39;eval_rec&#39;], 4))</span>
                            <span class="c1"># logger.info(&quot;  Best acc:%s&quot;, round(results[&#39;eval_acc&#39;], 4))</span>
                            <span class="c1"># logger.info(&quot;  &quot; + &quot;*&quot; * 20)</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The current best accuracy is: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">best_f1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="n">checkpoint_prefix</span> <span class="o">=</span> <span class="s1">&#39;checkpoint-best-acc&#39;</span>
                            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">checkpoint_prefix</span><span class="p">),)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
                            <span class="n">model_to_save</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span>
                            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;model.bin&#39;</span><span class="p">))</span>
                            <span class="c1"># torch.save(model_to_save.state_dict(), output_dir)</span>
                            <span class="c1"># logger.info(&quot;Saving model checkpoint to %s&quot;, output_dir)</span>
                            <span class="c1"># print(&quot;Saving model checkpoint to {}&quot;.format(output_dir))</span>

    <span class="k">return</span> <span class="n">best_f1</span></div>

<div class="viewcode-block" id="deploy"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.deploy">[docs]</a><span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploy the model for training with an incremental learning approach.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser containing model configuration.</span>
<span class="sd">    train_dataset : TextDataset</span>
<span class="sd">        Dataset for training.</span>
<span class="sd">    model : object</span>
<span class="sd">        Model to be trained.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance for data processing.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Best accuracy achieved during deployment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">per_gpu_train_batch_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span><span class="p">)</span>
    <span class="n">train_sampler</span> <span class="o">=</span> <span class="n">RandomSampler</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">DistributedSampler</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>

    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">train_sampler</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">max_steps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">warmup_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">logging_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span>
    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># Prepare optimizer and schedule (linear warmup and decay)</span>
    <span class="n">no_decay</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;LayerNorm.weight&#39;</span><span class="p">]</span>
    <span class="n">optimizer_grouped_parameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span>
         <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">()</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span> <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">(</span><span class="n">optimizer_grouped_parameters</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">get_linear_schedule_with_warmup</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_steps</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                                                <span class="n">num_training_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_steps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fp16</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">apex</span> <span class="kn">import</span> <span class="n">amp</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Please install apex from https://www.github.com/nvidia/apex to use fp16 training.&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">opt_level</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">fp16_opt_level</span><span class="p">)</span>

    <span class="c1"># multi-gpu training (should be after apex fp16 initialization)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Distributed training (should be after apex fp16 initialization)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">DistributedDataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">],</span>
                                                          <span class="n">output_device</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">,</span>
                                                          <span class="n">find_unused_parameters</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">checkpoint_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;checkpoint-last&#39;</span><span class="p">)</span>
    <span class="n">scheduler_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;scheduler.pt&#39;</span><span class="p">)</span>
    <span class="n">optimizer_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;optimizer.pt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">scheduler_last</span><span class="p">):</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">scheduler_last</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">optimizer_last</span><span class="p">):</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">optimizer_last</span><span class="p">))</span>
    <span class="c1"># Train!</span>
    <span class="c1"># logger.info(&quot;***** Running training *****&quot;)</span>
    <span class="c1"># logger.info(&quot;  Num examples = %d&quot;, len(train_dataset))</span>
    <span class="c1"># logger.info(&quot;  Num Epochs = %d&quot;, args.num_train_epochs)</span>
    <span class="c1"># logger.info(&quot;  Instantaneous batch size per GPU = %d&quot;, args.per_gpu_train_batch_size)</span>
    <span class="c1"># logger.info(&quot;  Total train batch size (w. parallel, distributed &amp; accumulation) = %d&quot;,</span>
    <span class="c1">#             args.train_batch_size * args.gradient_accumulation_steps * (</span>
    <span class="c1">#                 torch.distributed.get_world_size() if args.local_rank != -1 else 1))</span>
    <span class="c1"># logger.info(&quot;  Gradient Accumulation steps = %d&quot;, args.gradient_accumulation_steps)</span>
    <span class="c1"># logger.info(&quot;  Total optimization steps = %d&quot;, args.max_steps)</span>

    <span class="n">global_step</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">start_step</span>
    <span class="n">tr_loss</span><span class="p">,</span> <span class="n">logging_loss</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">tr_nb</span><span class="p">,</span> <span class="n">tr_num</span><span class="p">,</span> <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">best_mrr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">best_f1</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">best_f1_uq</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">best_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">increment_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># model.resize_token_embeddings(len(tokenizer))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_train_epochs</span><span class="p">)):</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">),</span><span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tr_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>

            <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># mean() to average on multi-gpu parallel training</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fp16</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">amp</span><span class="o">.</span><span class="n">scale_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span> <span class="k">as</span> <span class="n">scaled_loss</span><span class="p">:</span>
                    <span class="n">scaled_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">amp</span><span class="o">.</span><span class="n">master_params</span><span class="p">(</span><span class="n">optimizer</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">)</span>

            <span class="n">tr_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">tr_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">tr_loss</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">train_loss</span> <span class="o">/</span> <span class="n">tr_num</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;epoch </span><span class="si">{}</span><span class="s2"> loss </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">avg_loss</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">gradient_accumulation_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">output_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">tr_loss</span> <span class="o">-</span> <span class="n">logging_loss</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">global_step</span> <span class="o">-</span> <span class="n">tr_nb</span><span class="p">)),</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">logging_steps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">logging_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logging_loss</span> <span class="o">=</span> <span class="n">tr_loss</span>
                    <span class="n">tr_nb</span> <span class="o">=</span> <span class="n">global_step</span>

                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">global_step</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">save_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">evaluate_during_training</span><span class="p">:</span>  <span class="c1"># Only evaluate when single GPU otherwise metrics may not average well</span>
                        <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">eval_when_training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                            <span class="c1"># Save model checkpoint</span>
                        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval_acc&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_f1</span><span class="p">:</span>
                            <span class="n">best_f1</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval_acc&#39;</span><span class="p">]</span>
                            <span class="c1"># logger.info(&quot;  &quot; + &quot;*&quot; * 20)</span>
                            <span class="c1"># logger.info(&quot;  Best f1:%s&quot;, round(best_f1, 4))</span>
                            <span class="c1"># logger.info(&quot;  Best pre:%s&quot;, round(results[&#39;eval_pre&#39;], 4))</span>
                            <span class="c1"># logger.info(&quot;  Best rec:%s&quot;, round(results[&#39;eval_rec&#39;], 4))</span>
                            <span class="c1"># logger.info(&quot;  Best acc:%s&quot;, round(results[&#39;eval_acc&#39;], 4))</span>
                            <span class="c1"># logger.info(&quot;  &quot; + &quot;*&quot; * 20)</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The current accuracy is: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">best_f1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="n">checkpoint_prefix</span> <span class="o">=</span> <span class="s1">&#39;checkpoint-best-acc&#39;</span>
                            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">checkpoint_prefix</span><span class="p">),)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
                            <span class="n">model_to_save</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span>
                            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;model.bin&#39;</span><span class="p">))</span>
                            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_to_save</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">output_dir</span><span class="p">)</span>
                            <span class="c1"># logger.info(&quot;Saving model checkpoint to %s&quot;, output_dir)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving model checkpoint to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_dir</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval_acc&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;eval_acc&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.9</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;The current accuracy is: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">best_f1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">results_uq</span><span class="p">,</span> <span class="n">incre_index</span> <span class="o">=</span> <span class="n">conformal_prediction</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">results_uq</span><span class="p">[</span><span class="s1">&#39;find_f1&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_f1_uq</span><span class="p">:</span>
                                <span class="n">best_f1_uq</span> <span class="o">=</span> <span class="n">results_uq</span><span class="p">[</span><span class="s1">&#39;find_f1&#39;</span><span class="p">]</span>
                                <span class="c1"># # logger.info(&quot;  &quot; + &quot;*&quot; * 20)</span>
                                <span class="c1"># # logger.info(&quot;model prediction best f1:%s&quot;, round(results_uq[&#39;eval_acc&#39;], 4))</span>
                                <span class="c1"># logger.info(&quot;find accuracy：%.2f%%&quot; % (results_uq[&#39;find_acc&#39;] * 100))</span>
                                <span class="c1"># logger.info(&quot;find precision为：%.2f%%&quot; % (results_uq[&#39;find_pre&#39;] * 100))</span>
                                <span class="c1"># logger.info(&quot;find recall为：%.2f%%&quot; % (results_uq[&#39;find_rec&#39;] * 100))</span>
                                <span class="c1"># logger.info(&quot;find F1：%.2f%%&quot; % (best_f1_uq * 100))</span>
                                <span class="c1"># logger.info(&quot;  &quot; + &quot;*&quot; * 20)</span>
                                <span class="c1"># 将 logger.info 语句改为单行的 print 语句</span>
                                <span class="c1"># print(</span>
                                <span class="c1">#     f&quot;find accuracy：{results_uq[&#39;find_acc&#39;] * 100:.2f}%, &quot;</span>
                                <span class="c1">#     f&quot;find precision为：{results_uq[&#39;find_pre&#39;] * 100:.2f}%, &quot;</span>
                                <span class="c1">#     f&quot;find recall为：{results_uq[&#39;find_rec&#39;] * 100:.2f}%, &quot;</span>
                                <span class="c1">#     f&quot;find F1：{best_f1_uq * 100:.2f}%&quot;)</span>
                                <span class="c1"># print(&quot;  &quot; + &quot;*&quot; * 20)</span>

                                <span class="c1"># nni.report_intermediate_result(best_f1_uq)</span>
                                <span class="n">checkpoint_prefix</span> <span class="o">=</span> <span class="s1">&#39;checkpoint-best-acc&#39;</span>
                                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">checkpoint_prefix</span><span class="p">))</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
                                <span class="n">model_to_save</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span>
                                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;model.bin&#39;</span><span class="p">))</span>
                                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_to_save</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">output_dir</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving the retrained model checkpoint to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
                                <span class="c1"># 将 logger.info 语句改为 print 语句</span>
                                <span class="c1"># print(f&quot;Saving the retrained model checkpoint to {output_dir}&quot;)</span>
<span class="w">                                </span><span class="sd">&quot;&quot;&quot;increment learning&quot;&quot;&quot;</span>
                                <span class="c1"># train_dataset = TextDataset(tokenizer, args, args.train_data_file, args.one_hot_vectors,</span>
                                <span class="c1">#                             args.suffixes)</span>
                                <span class="c1"># test_dataset = TextDataset(tokenizer, args, args.test_data_file, args.one_hot_vectors,</span>
                                <span class="c1">#                            args.suffixes)</span>
                                <span class="c1"># incre_data = [test_dataset[i] for i in incre_index]</span>
                                <span class="c1">#</span>
                                <span class="c1"># train_dataset=train_dataset.append(incre_data)</span>
                                <span class="c1"># test_dataset = [item for index, item in enumerate(test_dataset) if</span>
                                <span class="c1">#                index not in incre_index]</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Incremental Learning...&quot;</span><span class="p">)</span>
                                <span class="n">selected_content</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">old_train</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">new_test</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">test_data_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonl_file</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jsonl_file</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">incre_index</span><span class="p">:</span>
                                            <span class="n">selected_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">new_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">train_data_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonl_file</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jsonl_file</span><span class="p">):</span>
                                        <span class="n">old_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

                                <span class="n">new_train</span> <span class="o">=</span> <span class="n">old_train</span> <span class="o">+</span> <span class="n">selected_content</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../../../benchmark/Bug/new_train.jsonl&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">selected_file</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_train</span><span class="p">:</span>
                                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">selected_file</span><span class="p">)</span>
                                        <span class="n">selected_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../../../benchmark/Bug/new_test.jsonl&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">selected_file</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_test</span><span class="p">:</span>
                                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">selected_file</span><span class="p">)</span>
                                        <span class="n">selected_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                                <span class="n">checkpoint_prefix</span> <span class="o">=</span> <span class="s1">&#39;checkpoint-best-acc/model.bin&#39;</span>
                                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">checkpoint_prefix</span><span class="p">))</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">output_dir</span><span class="p">))</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

                                <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;../../../benchmark/Bug/new_train.jsonl&#39;</span><span class="p">,</span>
                                                            <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span>
                                                            <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span><span class="p">)</span>
                                <span class="n">results_origin</span> <span class="o">=</span> <span class="n">evaluate_test</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
                                <span class="n">retrained_acc</span> <span class="o">=</span> <span class="n">incre</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
                                <span class="n">increment_acc_single</span> <span class="o">=</span> <span class="n">retrained_acc</span> <span class="o">-</span> <span class="n">results_origin</span><span class="p">[</span><span class="s2">&quot;test_acc&quot;</span><span class="p">]</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The retrained accuracy is: </span><span class="si">{</span><span class="n">retrained_acc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;The increment accuracy is: </span><span class="si">{</span><span class="n">increment_acc_single</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;The best increment accuracy is: </span><span class="si">{</span><span class="n">increment_acc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">increment_acc</span> <span class="o">&lt;</span> <span class="n">increment_acc_single</span><span class="p">:</span>
                                    <span class="n">increment_acc</span> <span class="o">=</span> <span class="n">increment_acc_single</span>
                                <span class="c1"># if retrained_acc &lt; increment_acc_single:</span>
                                <span class="c1">#     increment_acc = increment_acc_single</span>
                                <span class="c1"># if increment_acc &lt; increment_acc_single:</span>
                                <span class="c1">#     increment_acc = increment_acc_single</span>
    <span class="k">return</span> <span class="n">increment_acc</span></div>


<div class="viewcode-block" id="evaluate"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.evaluate">[docs]</a><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">eval_when_training</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the model performance on the validation dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser containing evaluation configuration.</span>
<span class="sd">    model : object</span>
<span class="sd">        Model to be evaluated.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance for data processing.</span>
<span class="sd">    eval_when_training : bool</span>
<span class="sd">        Flag indicating if evaluation should happen during training.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing evaluation metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Loop to handle MNLI double evaluation (matched, mis-matched)</span>
    <span class="n">eval_output_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_data_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">eval_output_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">eval_output_dir</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">per_gpu_eval_batch_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span><span class="p">)</span>
    <span class="c1"># Note that DistributedSampler samples randomly</span>
    <span class="n">eval_sampler</span> <span class="o">=</span> <span class="n">SequentialSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">DistributedSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span>
    <span class="n">eval_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">eval_sampler</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># multi-gpu evaluate</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">eval_when_training</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Eval!</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***** Running evaluation *****&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Num examples = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">))</span>
    <span class="c1"># logger.info(&quot;  Batch size = %d&quot;, args.eval_batch_size)</span>
    <span class="n">eval_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">nb_eval_steps</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">eval_dataloader</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">lm_loss</span><span class="p">,</span> <span class="n">logit</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">eval_loss</span> <span class="o">+=</span> <span class="n">lm_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">logits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">nb_eval_steps</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># 混淆矩阵</span>
    <span class="c1"># preds = logits[:, 0] &gt; 0.5</span>
    <span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span>
    <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">predict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
        <span class="c1"># 前向传播并获取预测结果</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">predict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">predict</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="c1"># top_values, top_indices = torch.topk(torch.tensor(predict), k=3)</span>
        <span class="c1"># 将真实标签和预测标签加入列表中</span>
        <span class="n">all_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">all_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predict</span><span class="p">)</span>
    <span class="n">confusion_mat</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># print(confusion_mat)</span>
    <span class="c1"># from sklearn.metrics import f1_score, accuracy_score,precision_score,recall_score</span>
    <span class="c1"># eval_f1 = f1_score(all_labels, all_predictions, average=&#39;weighted&#39;)</span>
    <span class="c1"># eval_acc = accuracy_score(all_labels, all_predictions)</span>
    <span class="c1"># eval_rec = recall_score(all_labels, all_predictions, average=&#39;weighted&#39;)</span>
    <span class="c1"># eval_loss = eval_loss / nb_eval_steps</span>
    <span class="c1"># perplexity = torch.tensor(eval_loss)</span>
    <span class="c1"># result = {</span>
    <span class="c1">#     &quot;eval_loss&quot;: float(perplexity),</span>
    <span class="c1">#     &quot;eval_acc&quot;: round(eval_acc, 4),</span>
    <span class="c1">#     &quot;eval_rec&quot;: round(eval_rec, 4),</span>
    <span class="c1">#     &quot;eval_f1&quot;: round(eval_f1, 4),</span>
    <span class="c1"># }</span>
    <span class="c1"># return result</span>
    <span class="n">TP</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># FP=0</span>
    <span class="c1"># FN=0</span>
    <span class="n">TN</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
        <span class="c1"># original positive</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
            <span class="c1"># 预测正确</span>
            <span class="n">TP</span> <span class="o">=</span> <span class="n">TP</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 预测错误</span>
            <span class="n">TN</span> <span class="o">=</span> <span class="n">TN</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># if i == 1 and j == 1:</span>
        <span class="c1">#     TP=TP+1</span>
        <span class="c1"># elif i == 1 and j == 0:</span>
        <span class="c1">#     FN=FN+1</span>
        <span class="c1"># elif i == 0 and j == 1:</span>
        <span class="c1">#     FP = FP + 1</span>
        <span class="c1"># elif i == 0 and j == 0:</span>
        <span class="c1">#     TN=TN+1</span>

    <span class="n">eval_acc</span> <span class="o">=</span> <span class="n">TP</span> <span class="o">/</span> <span class="p">(</span><span class="n">TP</span> <span class="o">+</span> <span class="n">TN</span><span class="p">)</span>
    <span class="c1"># try:</span>
    <span class="c1">#     eval_pre = TP/(TP+FP)</span>
    <span class="c1"># except:</span>
    <span class="c1">#     eval_pre= 0</span>
    <span class="c1"># try:</span>
    <span class="c1">#     eval_rec = TP/(TP+FN)</span>
    <span class="c1"># except:</span>
    <span class="c1">#     eval_rec = 0</span>
    <span class="c1"># try:</span>
    <span class="c1">#     eval_f1 = 2 * eval_pre*eval_rec/(eval_pre+eval_rec)</span>
    <span class="c1"># except:</span>
    <span class="c1">#     eval_f1 = 0</span>

    <span class="c1"># eval_acc = np.mean(labels == preds)</span>
    <span class="n">eval_loss</span> <span class="o">=</span> <span class="n">eval_loss</span> <span class="o">/</span> <span class="n">nb_eval_steps</span>
    <span class="n">perplexity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">eval_loss</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;eval_loss&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">perplexity</span><span class="p">),</span>
        <span class="s2">&quot;eval_acc&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">eval_acc</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="c1"># &quot;eval_pre&quot;: round(eval_pre, 4),</span>
        <span class="c1"># &quot;eval_rec&quot;: round(eval_rec, 4),</span>
        <span class="c1"># &quot;eval_f1&quot;: round(eval_f1, 4),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="conformal_prediction"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.conformal_prediction">[docs]</a><span class="k">def</span> <span class="nf">conformal_prediction</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform conformal prediction for uncertainty quantification.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser containing configuration.</span>
<span class="sd">    model : object</span>
<span class="sd">        Model for prediction.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance for data processing.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Contains result dictionary and list of selected indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Loop to handle MNLI double evaluation (matched, mis-matched)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start the conformal prediction...&quot;</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">find_pre</span><span class="p">,</span> <span class="n">find_recall</span>
    <span class="n">eval_output_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_data_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span><span class="p">)</span>
    <span class="c1"># if not os.path.exists(eval_output_dir) and args.local_rank in [-1, 0]:</span>
    <span class="c1">#     os.makedirs(eval_output_dir)</span>
    <span class="c1"># args.eval_batch_size = args.per_gpu_eval_batch_size * max(1, args.n_gpu)</span>
    <span class="c1"># Note that DistributedSampler samples randomly</span>
    <span class="n">eval_sampler</span> <span class="o">=</span> <span class="n">SequentialSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">DistributedSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span>
    <span class="n">eval_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">eval_sampler</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Eval!</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x_val</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">eval_dataloader</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">x_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="c1"># with torch.no_grad():</span>
        <span class="c1">#     lm_loss, logit = model(inputs, label)</span>
        <span class="c1">#     labels.append(label.cpu().numpy())</span>
        <span class="c1">#     x_val.append(logit.cpu().numpy())</span>

    <span class="n">y_cal_single</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">X_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y_cal</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">y_cal_single</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">y_cal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="c1"># Loop to handle MNLI double evaluation (matched, mis-matched)</span>
    <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">test_data_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">per_gpu_eval_batch_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span><span class="p">)</span>
    <span class="c1"># Note that DistributedSampler samples randomly</span>
    <span class="n">eval_sampler</span> <span class="o">=</span> <span class="n">SequentialSampler</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">DistributedSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span>
    <span class="n">eval_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">eval_sampler</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span><span class="p">)</span>
    <span class="c1"># multi-gpu evaluate</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="c1"># TEST!</span>

    <span class="n">x_test</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">eval_dataloader</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">x_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="c1"># with torch.no_grad():</span>
        <span class="c1">#     logit = model(inputs)</span>
        <span class="c1">#     logits.append(logit.cpu().numpy())</span>
        <span class="c1">#     labels.append(label.cpu().numpy())</span>

    <span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y_test_single</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">y_test_single</span><span class="p">:</span>
        <span class="c1"># 前向传播并获取预测结果</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="c1"># 将真实标签和预测标签加入列表中</span>
        <span class="n">y_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="c1"># for label in y_test_single:</span>
    <span class="c1">#     # 前向传播并获取预测结果</span>
    <span class="c1">#     label = torch.argmax(torch.tensor(label)).item()</span>
    <span class="c1">#     # 将真实标签和预测标签加入列表中</span>
    <span class="c1">#     y_test.append(label)</span>
    <span class="c1">###########UQ</span>
    <span class="c1"># clf = GaussianNB().fit(X_cal, y_cal)</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">model</span>
    <span class="c1"># mapie_score = MapieClassifier(estimator=clf, cv=&quot;prefit&quot;, method=args.method, random_state=42)</span>
    <span class="c1"># raps cumulated_score naive</span>
    <span class="n">method_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;lac&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;aps&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;cumulated_score&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;raps&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;raps&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">Prom_thread</span> <span class="o">=</span> <span class="n">Prom_utils</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">method_params</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s2">&quot;bug&quot;</span><span class="p">)</span>

    <span class="n">calibration_data</span> <span class="o">=</span> <span class="n">X_cal</span>
    <span class="n">cal_y</span><span class="o">=</span> <span class="n">y_cal</span>
    <span class="n">test_x</span><span class="o">=</span> <span class="n">X_test</span>
    <span class="n">test_y</span><span class="o">=</span> <span class="n">y_test</span>
    <span class="n">all_pre</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_preds</span><span class="p">,</span> <span class="n">y_pss</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">Prom_thread</span><span class="o">.</span><span class="n">conformal_prediction</span><span class="p">(</span>
        <span class="n">cal_x</span><span class="o">=</span><span class="n">calibration_data</span><span class="p">,</span> <span class="n">cal_y</span><span class="o">=</span><span class="n">cal_y</span><span class="p">,</span> <span class="n">test_x</span><span class="o">=</span><span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span><span class="o">=</span><span class="n">test_y</span><span class="p">,</span> <span class="n">significance_level</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

    <span class="c1"># Evaluate conformal prediction</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detect the drifting samples...&quot;</span><span class="p">)</span>
    <span class="c1"># Prom_thread.evaluate_mapie \</span>
    <span class="c1">#     (y_preds=y_preds, y_pss=y_pss, p_value=p_value, all_pre=all_pre, y=y_test,</span>
    <span class="c1">#      significance_level=0.05)</span>
    <span class="c1">#</span>
    <span class="c1"># Prom_thread.evaluate_rise \</span>
    <span class="c1">#     (y_preds=y_preds, y_pss=y_pss, p_value=p_value, all_pre=all_pre, y=y_test,</span>
    <span class="c1">#      significance_level=0.05)</span>

    <span class="n">index_all_right</span><span class="p">,</span> <span class="n">index_list_right</span><span class="p">,</span> <span class="n">Acc_all</span><span class="p">,</span> <span class="n">F1_all</span><span class="p">,</span> <span class="n">Pre_all</span><span class="p">,</span> <span class="n">Rec_all</span><span class="p">,</span><span class="n">index_list</span><span class="p">,</span><span class="n">common_elements</span> \
        <span class="o">=</span> <span class="n">Prom_thread</span><span class="o">.</span><span class="n">evaluate_conformal_prediction</span> \
        <span class="p">(</span><span class="n">y_preds</span><span class="o">=</span><span class="n">y_preds</span><span class="p">,</span> <span class="n">y_pss</span><span class="o">=</span><span class="n">y_pss</span><span class="p">,</span> <span class="n">p_value</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span> <span class="n">all_pre</span><span class="o">=</span><span class="n">all_pre</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span><span class="n">significance_level</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

    <span class="c1"># Increment learning</span>
    <span class="c1"># print(&quot;Finding the most valuable instances for incremental learning...&quot;)</span>
    <span class="c1">#</span>
    <span class="c1"># print(&quot;a&quot;)</span>
    <span class="c1"># # y_preds, y_pss = {}, {}</span>
    <span class="c1"># # alphas = np.arange(0.1, 1, 0.1)</span>
    <span class="c1"># # # alphas=[0.1]</span>
    <span class="c1"># # for name, (method, include_last_label) in method_params.items():</span>
    <span class="c1"># #     mapie = MapieClassifier(estimator=clf, method=method, cv=&quot;prefit&quot;, random_state=42)</span>
    <span class="c1"># #     mapie.fit(X_cal, y_cal)</span>
    <span class="c1"># #     y_preds[name], y_pss[name] = mapie.predict(X_test, alpha=alphas, include_last_label=include_last_label)</span>
    <span class="c1">#</span>
    <span class="c1"># ##########</span>
    <span class="c1"># # def count_null_set(y: np.ndarray) -&gt; int:</span>
    <span class="c1"># #     &quot;&quot;&quot;</span>
    <span class="c1"># #     Count the number of empty prediction sets.</span>
    <span class="c1"># #</span>
    <span class="c1"># #     Parameters</span>
    <span class="c1"># #     ----------</span>
    <span class="c1"># #     y: np.ndarray of shape (n_sample, )</span>
    <span class="c1"># #</span>
    <span class="c1"># #     Returns</span>
    <span class="c1"># #     -------</span>
    <span class="c1"># #     int</span>
    <span class="c1"># #     &quot;&quot;&quot;</span>
    <span class="c1"># #     count = 0</span>
    <span class="c1"># #     for pred in y[:, :]:</span>
    <span class="c1"># #         if np.sum(pred) == 0:</span>
    <span class="c1"># #             count += 1</span>
    <span class="c1"># #     return count</span>
    <span class="c1">#</span>
    <span class="c1"># # nulls, coverages, accuracies, sizes = {}, {}, {}, {}</span>
    <span class="c1"># # for name, (method, include_last_label) in method_params.items():</span>
    <span class="c1"># #     accuracies[name] = accuracy_score(y_test, y_preds[name])</span>
    <span class="c1"># #     nulls[name] = [</span>
    <span class="c1"># #         count_null_set(y_pss[name][:, :, i]) for i, _ in enumerate(alphas)</span>
    <span class="c1"># #     ]</span>
    <span class="c1"># #     coverages[name] = [</span>
    <span class="c1"># #         classification_coverage_score(</span>
    <span class="c1"># #             y_test, y_pss[name][:, :, i]</span>
    <span class="c1"># #         ) for i, _ in enumerate(alphas)</span>
    <span class="c1"># #     ]</span>
    <span class="c1"># #     sizes[name] = [</span>
    <span class="c1"># #         y_pss[name][:, :, i].sum(axis=1).mean() for i, _ in enumerate(alphas)</span>
    <span class="c1"># #     ]</span>
    <span class="c1"># # # sizes里每个method最接近1的</span>
    <span class="c1"># # result = {}  # 用于存储结果的字典</span>
    <span class="c1"># # for key, lst in sizes.items():  # 遍历字典的键值对</span>
    <span class="c1"># #     closest_index = min(range(len(lst)), key=lambda i: abs(lst[i] - 1))  # 找到最接近1的数字的索引</span>
    <span class="c1"># #     result[key] = closest_index  # 将结果存入字典</span>
    <span class="c1"># # # y_ps_90中提出来那个最接近1的位置</span>
    <span class="c1"># # result_ps = {}</span>
    <span class="c1"># # for method, y_ps in y_pss.items():</span>
    <span class="c1"># #     result_ps[method] = y_ps[:, :, result[method]]</span>
    <span class="c1"># #</span>
    <span class="c1"># # index_all_tem = {}</span>
    <span class="c1"># # index_all_right_tem = {}</span>
    <span class="c1"># # for method, y_ps in result_ps.items():</span>
    <span class="c1"># #     for index, i in enumerate(y_ps):</span>
    <span class="c1"># #         num_true = sum(i)</span>
    <span class="c1"># #         if method not in index_all_tem:</span>
    <span class="c1"># #             index_all_tem[method] = []</span>
    <span class="c1"># #             index_all_right_tem[method] = []</span>
    <span class="c1"># #         if num_true != 1:</span>
    <span class="c1"># #             index_all_tem[method].append(index)</span>
    <span class="c1"># #         elif num_true == 1:</span>
    <span class="c1"># #             index_all_right_tem[method].append(index)</span>
    <span class="c1"># # index_all = []</span>
    <span class="c1"># # index_list = []</span>
    <span class="c1"># # # 遍历字典中的每个键值对</span>
    <span class="c1"># # for key, value in index_all_tem.items():</span>
    <span class="c1"># #     # 使用集合对列表中的元素进行去重，并转换为列表</span>
    <span class="c1"># #     list_length = len(value)</span>
    <span class="c1"># #     # print(f&quot;Length of {key}: {list_length}&quot;)</span>
    <span class="c1"># #     # 将去重后的列表添加到新列表中</span>
    <span class="c1"># #     index_all.extend(value)</span>
    <span class="c1"># #     index_list.append(value)</span>
    <span class="c1"># # index_all = list(set(index_all))</span>
    <span class="c1"># # # print(f&quot;Length of index_all: {len(index_all)}&quot;)</span>
    <span class="c1"># # index_list.append(index_all)</span>
    <span class="c1"># #</span>
    <span class="c1"># # index_all_right = []</span>
    <span class="c1"># # index_list_right = []</span>
    <span class="c1"># # # 遍历字典中的每个键值对</span>
    <span class="c1"># # for key, value in index_all_right_tem.items():</span>
    <span class="c1"># #     # 使用集合对列表中的元素进行去重，并转换为列表</span>
    <span class="c1"># #     list_length = len(value)</span>
    <span class="c1"># #     # print(f&quot;Length of {key}: {list_length}&quot;)</span>
    <span class="c1"># #     # 将去重后的列表添加到新列表中</span>
    <span class="c1"># #     index_all_right.extend(value)</span>
    <span class="c1"># #     index_list_right.append(value)</span>
    <span class="c1">#</span>
    <span class="c1"># index_all_right = list(set(list(range(len(y_test)))) - set(index_all))</span>
    <span class="c1"># # print(f&quot;Length of index_all: {len(index_all_right)}&quot;)</span>
    <span class="c1"># index_list_right.append(index_all_right)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;metric&quot;&quot;&quot;</span>
    <span class="c1"># acc_best = 0</span>
    <span class="c1"># F1_best = 0</span>
    <span class="c1"># pre_best = 0</span>
    <span class="c1"># rec_best = 0</span>
    <span class="c1"># # 投票</span>
    <span class="c1"># method_name = {</span>
    <span class="c1">#     # &quot;naive&quot;: (&quot;naive&quot;, False),</span>
    <span class="c1">#     &quot;score&quot;: (&quot;score&quot;, False),</span>
    <span class="c1">#     &quot;cumulated_score&quot;: (&quot;cumulated_score&quot;, True),</span>
    <span class="c1">#     &quot;random_cumulated_score&quot;: (&quot;cumulated_score&quot;, &quot;randomized&quot;),</span>
    <span class="c1">#     &quot;top_k&quot;: (&quot;top_k&quot;, False),</span>
    <span class="c1">#     &quot;mixture&quot;: (&quot;mixture&quot;, False)</span>
    <span class="c1"># }</span>
    <span class="c1"># # 合并三个数组</span>
    <span class="c1"># find_recall = 0</span>
    <span class="c1"># find_pre = 0</span>
    <span class="c1"># find_acc = 0</span>
    <span class="c1"># random_element = []</span>
    <span class="c1"># for index_all, method_name_single in zip(index_list, method_name):</span>
        <span class="c1"># # 被错误分类的index</span>
        <span class="c1"># find_right_wrong = []</span>
        <span class="c1"># all_wrong = []</span>
        <span class="c1"># # 模型预测不准确的并且是(beigien)de</span>
        <span class="c1"># find_neg_right = []</span>
        <span class="c1"># index_tem = 0</span>
        <span class="c1"># predict_labels = model.predict(X_test)</span>
        <span class="c1"># for label, predict in zip(y_test_single, predict_labels):</span>
        <span class="c1">#     _, true_label = torch.topk(torch.tensor(label), k=1)</span>
        <span class="c1">#     pred_label = predict</span>
        <span class="c1">#     if index_tem in index_all:</span>
        <span class="c1">#         if true_label != pred_label:</span>
        <span class="c1">#             # 不确定的index中被错误分类的index（找到的不对的）</span>
        <span class="c1">#             find_right_wrong.append(index_tem)</span>
        <span class="c1">#             all_wrong.append(index_tem)</span>
        <span class="c1">#         # 找到的对的</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         if true_label != pred_label:</span>
        <span class="c1">#             # 被错误分类的index（找到的不对的）</span>
        <span class="c1">#             all_wrong.append(index_tem)</span>
        <span class="c1">#         if true_label == pred_label:</span>
        <span class="c1">#             find_neg_right.append(index_tem)</span>
        <span class="c1">#     index_tem += 1</span>
        <span class="c1"># find_acc = (len(find_right_wrong) + len(find_neg_right)) / len(y_test_single)</span>
        <span class="c1"># # 找对了多少</span>
        <span class="c1"># if index_all == []:</span>
        <span class="c1">#     find_pre = 0</span>
        <span class="c1"># else:</span>
        <span class="c1">#     find_pre = len(find_right_wrong) / len(index_all)</span>
        <span class="c1"># # 有多少被找出来了（找到的不对的/所有不对的）</span>
        <span class="c1"># if len(all_wrong) == 0:</span>
        <span class="c1">#     break</span>
        <span class="c1"># find_recall = len(find_right_wrong) / len(all_wrong)</span>
        <span class="c1"># try:</span>
        <span class="c1">#     F1_find = 2 * find_pre * find_recall / (find_pre + find_recall)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     F1_find = 0</span>
        <span class="c1"># if F1_best &lt; F1_find:</span>
        <span class="c1">#     F1_best = F1_find</span>
        <span class="c1">#     acc_best = find_acc</span>
        <span class="c1">#     pre_best = find_pre</span>
        <span class="c1">#     rec_best = find_recall</span>
        <span class="c1"># logger.info(f&quot;{method_name_single} find accuracy：{find_acc * 100:.2f}% &quot;</span>
        <span class="c1">#             f&quot;find precision为：{find_pre * 100:.2f}% &quot;</span>
        <span class="c1">#             f&quot;find recall为：{find_recall * 100:.2f}% &quot;</span>
        <span class="c1">#             f&quot;find F1：{F1_find * 100:.2f}%&quot;)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;IL&quot;&quot;&quot;</span>

    <span class="n">selected_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">random_element</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">common_elements</span><span class="p">,</span> <span class="n">selected_count</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">random_element</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test_single</span><span class="p">)),</span> <span class="n">selected_count</span><span class="p">)</span>

    <span class="c1"># logger.info(f&quot;Best find ACC_best：{acc_best * 100:.2f}% &quot;</span>
    <span class="c1">#             f&quot;Best find pre_best：{pre_best * 100:.2f}% &quot;</span>
    <span class="c1">#             f&quot;Best find rec_best：{rec_best * 100:.2f}% &quot;</span>
    <span class="c1">#             f&quot;Best find F1_best：{F1_best * 100:.2f}%&quot;)</span>
    <span class="c1"># F1_find = F1_best</span>
    <span class="c1">#</span>
    <span class="c1"># Acc_all, F1_all, Pre_all, Rec_all</span>
    <span class="n">result_find</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;find_acc&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">Acc_all</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s2">&quot;find_pre&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">Pre_all</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s2">&quot;find_rec&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">Rec_all</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s2">&quot;find_f1&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">F1_all</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result_find</span><span class="p">,</span> <span class="n">random_element</span></div>


<div class="viewcode-block" id="evaluate_test"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.evaluate_test">[docs]</a><span class="k">def</span> <span class="nf">evaluate_test</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">eval_when_training</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the model performance on a test dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser containing evaluation configuration, including output directory,</span>
<span class="sd">        batch sizes, device, and other model parameters.</span>
<span class="sd">    model : object</span>
<span class="sd">        The model to be evaluated, such as a neural network model.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance used for data processing.</span>
<span class="sd">    eval_when_training : bool, optional</span>
<span class="sd">        If True, evaluation will happen during training. Defaults to False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing evaluation metrics:</span>
<span class="sd">        - &quot;test_loss&quot; : float : Perplexity computed from evaluation loss.</span>
<span class="sd">        - &quot;test_acc&quot; : float : Accuracy of the model on the test dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Loop to handle MNLI double evaluation (matched, mis-matched)</span>
    <span class="n">eval_output_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s2">&quot;../../../benchmark/Bug/new_train.jsonl&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">eval_output_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">eval_output_dir</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">per_gpu_eval_batch_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span><span class="p">)</span>
    <span class="c1"># Note that DistributedSampler samples randomly</span>
    <span class="n">eval_sampler</span> <span class="o">=</span> <span class="n">SequentialSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">DistributedSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span>
    <span class="n">eval_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">eval_sampler</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># multi-gpu evaluate</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">eval_when_training</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Eval!</span>
    <span class="c1"># logger.info(&quot;***** Running evaluation *****&quot;)</span>
    <span class="c1"># logger.info(&quot;  Num examples = %d&quot;, len(eval_dataset))</span>
    <span class="c1"># logger.info(&quot;  Batch size = %d&quot;, args.eval_batch_size)</span>
    <span class="n">eval_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">nb_eval_steps</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">eval_dataloader</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">lm_loss</span><span class="p">,</span> <span class="n">logit</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">eval_loss</span> <span class="o">+=</span> <span class="n">lm_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">logits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">nb_eval_steps</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># 混淆矩阵</span>
    <span class="c1"># preds = logits[:, 0] &gt; 0.5</span>
    <span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span>
    <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">predict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
        <span class="c1"># 前向传播并获取预测结果</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">predict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">predict</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="c1"># top_values, top_indices = torch.topk(torch.tensor(predict), k=3)</span>
        <span class="c1"># 将真实标签和预测标签加入列表中</span>
        <span class="n">all_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">all_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predict</span><span class="p">)</span>
    <span class="n">confusion_mat</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">)</span>
    <span class="c1"># print(confusion_mat)</span>
    <span class="c1"># from sklearn.metrics import f1_score, accuracy_score,precision_score,recall_score</span>
    <span class="c1"># eval_f1 = f1_score(all_labels, all_predictions, average=&#39;weighted&#39;)</span>
    <span class="c1"># eval_acc = accuracy_score(all_labels, all_predictions)</span>
    <span class="c1"># eval_rec = recall_score(all_labels, all_predictions, average=&#39;weighted&#39;)</span>
    <span class="c1"># eval_loss = eval_loss / nb_eval_steps</span>
    <span class="c1"># perplexity = torch.tensor(eval_loss)</span>
    <span class="c1"># result = {</span>
    <span class="c1">#     &quot;eval_loss&quot;: float(perplexity),</span>
    <span class="c1">#     &quot;eval_acc&quot;: round(eval_acc, 4),</span>
    <span class="c1">#     &quot;eval_rec&quot;: round(eval_rec, 4),</span>
    <span class="c1">#     &quot;eval_f1&quot;: round(eval_f1, 4),</span>
    <span class="c1"># }</span>
    <span class="c1"># return result</span>
    <span class="n">TP</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># FP=0</span>
    <span class="c1"># FN=0</span>
    <span class="n">TN</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
        <span class="c1"># original positive</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
            <span class="c1"># 预测正确</span>
            <span class="n">TP</span> <span class="o">=</span> <span class="n">TP</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 预测错误</span>
            <span class="n">TN</span> <span class="o">=</span> <span class="n">TN</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># if i == 1 and j == 1:</span>
        <span class="c1">#     TP=TP+1</span>
        <span class="c1"># elif i == 1 and j == 0:</span>
        <span class="c1">#     FN=FN+1</span>
        <span class="c1"># elif i == 0 and j == 1:</span>
        <span class="c1">#     FP = FP + 1</span>
        <span class="c1"># elif i == 0 and j == 0:</span>
        <span class="c1">#     TN=TN+1</span>

    <span class="n">eval_acc</span> <span class="o">=</span> <span class="n">TP</span> <span class="o">/</span> <span class="p">(</span><span class="n">TP</span> <span class="o">+</span> <span class="n">TN</span><span class="p">)</span>
    <span class="c1"># try:</span>
    <span class="c1">#     eval_pre = TP/(TP+FP)</span>
    <span class="c1"># except:</span>
    <span class="c1">#     eval_pre= 0</span>
    <span class="c1"># try:</span>
    <span class="c1">#     eval_rec = TP/(TP+FN)</span>
    <span class="c1"># except:</span>
    <span class="c1">#     eval_rec = 0</span>
    <span class="c1"># try:</span>
    <span class="c1">#     eval_f1 = 2 * eval_pre*eval_rec/(eval_pre+eval_rec)</span>
    <span class="c1"># except:</span>
    <span class="c1">#     eval_f1 = 0</span>

    <span class="c1"># eval_acc = np.mean(labels == preds)</span>
    <span class="n">eval_loss</span> <span class="o">=</span> <span class="n">eval_loss</span> <span class="o">/</span> <span class="n">nb_eval_steps</span>
    <span class="n">perplexity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">eval_loss</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test_loss&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">perplexity</span><span class="p">),</span>
        <span class="s2">&quot;test_acc&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">eval_acc</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="c1"># &quot;eval_pre&quot;: round(eval_pre, 4),</span>
        <span class="c1"># &quot;eval_rec&quot;: round(eval_rec, 4),</span>
        <span class="c1"># &quot;eval_f1&quot;: round(eval_f1, 4),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="epoch_test"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.epoch_test">[docs]</a><span class="k">def</span> <span class="nf">epoch_test</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluates the model performance on a test dataset for each epoch.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser containing evaluation configuration, such as file paths, batch sizes, and device setup.</span>
<span class="sd">    model : object</span>
<span class="sd">        The model to be evaluated.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance used to process the dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing evaluation metrics:</span>
<span class="sd">        - &quot;test_acc&quot; : float : Accuracy of the model on the test dataset.</span>
<span class="sd">        - &quot;test_rec&quot; : float : Recall of the model on the test dataset.</span>
<span class="sd">        - &quot;test_f1&quot; : float : F1 score of the model on the test dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Loop to handle MNLI double evaluation (matched, mis-matched)</span>
    <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">test_data_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">per_gpu_eval_batch_size</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span><span class="p">)</span>
    <span class="c1"># Note that DistributedSampler samples randomly</span>
    <span class="n">eval_sampler</span> <span class="o">=</span> <span class="n">SequentialSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">DistributedSampler</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">)</span>
    <span class="n">eval_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">eval_sampler</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span><span class="p">)</span>

    <span class="c1"># multi-gpu evaluate</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Eval!</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***** Running Test *****&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Num examples = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Batch size = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span><span class="p">)</span>

    <span class="n">eval_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">eval_dataloader</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_dataloader</span><span class="p">),</span><span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">logit</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

    <span class="n">logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">all_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">predict</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
        <span class="c1"># 前向传播并获取预测结果</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">predict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">predict</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># 将真实标签和预测标签加入列表中</span>
        <span class="n">all_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">all_predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predict</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span>
    <span class="n">test_f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">test_acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">)</span>
    <span class="n">test_rec</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">all_labels</span><span class="p">,</span> <span class="n">all_predictions</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">perplexity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">eval_loss</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;test_acc&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">test_acc</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s2">&quot;test_rec&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">test_rec</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s2">&quot;test_f1&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">test_f1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="mi">4</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">result</span></div>
    <span class="c1"># preds = logits[:, 0] &gt; 0.5</span>
    <span class="c1"># with open(os.path.join(args.output_dir, &quot;predictions.txt&quot;), &#39;w&#39;) as f:</span>
    <span class="c1">#     for example, pred in zip(eval_dataset.examples, preds):</span>
    <span class="c1">#         if pred:</span>
    <span class="c1">#             f.write(example.idx + &#39;\t1\n&#39;)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             f.write(example.idx + &#39;\t0\n&#39;)</span>

    <span class="c1"># Evaluation</span>
    <span class="c1"># results = {}</span>
    <span class="c1"># if args.do_eval and args.local_rank in [-1, 0]:</span>
    <span class="c1"># checkpoint_prefix = &#39;checkpoint-best-acc/model.bin&#39;</span>
    <span class="c1"># output_dir = os.path.join(args.output_dir, &#39;{}&#39;.format(checkpoint_prefix))</span>
    <span class="c1"># model.load_state_dict(torch.load(output_dir))</span>
    <span class="c1"># model.to(args.device)</span>
    <span class="c1"># results = evaluate_test(args, model, tokenizer)</span>
    <span class="c1"># logger.info(&quot;***** Eval results *****&quot;)</span>
    <span class="c1"># # a=result[&#39;eval_f1&#39;]</span>
    <span class="c1"># for key in sorted(results.keys()):</span>
    <span class="c1">#     logger.info(&quot;  %s = %s&quot;, key, str(round(results[key], 4)))</span>
    <span class="c1"># results=epoch_uq(args, model, tokenizer)</span>
    <span class="c1"># nni.report_final_result(best_f1_uq)</span>

    <span class="c1"># if args.do_test and args.local_rank in [-1, 0]:</span>
    <span class="c1"># checkpoint_prefix = &#39;checkpoint-best-acc/model.bin&#39;</span>
    <span class="c1"># output_dir = os.path.join(args.output_dir, &#39;{}&#39;.format(checkpoint_prefix))</span>
    <span class="c1"># model.load_state_dict(torch.load(output_dir))</span>
    <span class="c1"># model.to(args.device)</span>
    <span class="c1"># aates(args, model, tokenizer)</span>

    <span class="c1"># return increment_acc</span>


<div class="viewcode-block" id="model_initial"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.model_initial">[docs]</a><span class="k">def</span> <span class="nf">model_initial</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes model parameters, configurations, and tokenizer.</span>

<span class="sd">    Uses hyperparameters from nni for tuning if available, otherwise defaults to specified parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        - model : object : The initialized model.</span>
<span class="sd">        - config : object : Model configuration.</span>
<span class="sd">        - tokenizer : object : Tokenizer instance.</span>
<span class="sd">        - args : argparse.Namespace : Argument parser with model configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">nni</span><span class="o">.</span><span class="n">get_next_parameter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">params</span> <span class="o">==</span> <span class="p">{}:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="mf">0.0002</span><span class="p">,</span>
            <span class="c1"># &quot;alpha&quot;: 0.1,</span>
            <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
            <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">2811</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="c1">## Required parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--train_data_file&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The input training data file (a text file).&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output_dir&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output directory where the model predictions and checkpoints will be written.&quot;</span><span class="p">)</span>
    <span class="c1">## Other parameters</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--eval_data_file&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;An optional input evaluation data file to evaluate the perplexity on (a text file).&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--test_data_file&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;An optional input evaluation data file to evaluate the perplexity on (a text file).&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model_type&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;bert&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The model architecture to be fine-tuned.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--model_name_or_path&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The model checkpoint for weights initialization.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mlm&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Train with masked-language modeling loss instead of language modeling.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mlm_probability&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Ratio of tokens to mask for masked language modeling loss&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--config_name&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optional pretrained config name or path if not the same as model_name_or_path&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--tokenizer_name&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optional pretrained tokenizer name or path if not the same as model_name_or_path&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--cache_dir&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optional directory to store the pre-trained models downloaded from s3 (instread of the default one)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--block_size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optional input sequence length after tokenization.&quot;</span>
                             <span class="s2">&quot;The training dataset will be truncated in block of this size for training.&quot;</span>
                             <span class="s2">&quot;Default to the model max input length for single sentence inputs (take into account special tokens).&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--do_train&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to run training.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--do_eval&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to run eval on the dev set.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--do_test&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to run eval on the dev set.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--evaluate_during_training&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run evaluation during training at each logging step.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--do_lower_case&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set this flag if you are using an uncased model.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--train_batch_size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Batch size per GPU/CPU for training.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--eval_batch_size&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Batch size per GPU/CPU for evaluation.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--gradient_accumulation_steps&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of updates steps to accumulate before performing a backward/update pass.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--learning_rate&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The initial learning rate for Adam.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--weight_decay&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Weight deay if we apply some.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--adam_epsilon&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Epsilon for Adam optimizer.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--max_grad_norm&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Max gradient norm.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--num_train_epochs&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Total number of training epochs to perform.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--alpha&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--max_steps&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If &gt; 0: set total number of training steps to perform. Override num_train_epochs.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--warmup_steps&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Linear warmup over warmup_steps.&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--logging_steps&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Log every X updates steps.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_steps&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save checkpoint every X updates steps.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_total_limit&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Limit the total amount of checkpoints, delete the older checkpoints in the output_dir, does not delete by default&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--eval_all_checkpoints&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Evaluate all checkpoints starting with the same prefix as model_name_or_path ending and ending with step number&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no_cuda&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Avoid using CUDA when available&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--overwrite_output_dir&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Overwrite the content of the output directory&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--overwrite_cache&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Overwrite the cached training and evaluation sets&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--seed&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;random seed for initialization&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--epoch&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;random seed for initialization&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--fp16&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use 16-bit (mixed) precision (through NVIDIA apex) instead of 32-bit&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--fp16_opt_level&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;O1&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For fp16: Apex AMP optimization level selected in [&#39;O0&#39;, &#39;O1&#39;, &#39;O2&#39;, and &#39;O3&#39;].&quot;</span>
                             <span class="s2">&quot;See details at https://nvidia.github.io/apex/amp.html&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--local_rank&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For distributed training: local_rank&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--server_ip&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For distant debugging.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--server_port&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For distant debugging.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--method&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;top_k&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--mode&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Mode to run: train or deploy&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Setup distant debugging if needed</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">server_ip</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">server_port</span><span class="p">:</span>
        <span class="c1"># Distant debugging - see https://code.visualstudio.com/docs/python/debugging#_attach-to-a-local-script</span>
        <span class="kn">import</span> <span class="nn">ptvsd</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for debugger attach&quot;</span><span class="p">)</span>
        <span class="n">ptvsd</span><span class="o">.</span><span class="n">enable_attach</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">server_ip</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">server_port</span><span class="p">),</span> <span class="n">redirect_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ptvsd</span><span class="o">.</span><span class="n">wait_for_attach</span><span class="p">()</span>

    <span class="c1"># Setup CUDA, GPU &amp; distributed training</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">no_cuda</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_cuda</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Initializes the distributed backend which will take care of sychronizing nodes/GPUs</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">)</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;nccl&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
    <span class="n">args</span><span class="o">.</span><span class="n">per_gpu_train_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">train_batch_size</span>
    <span class="n">args</span><span class="o">.</span><span class="n">per_gpu_eval_batch_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_batch_size</span>
    <span class="c1"># Setup logging</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> -   </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y %H:%M:%S&#39;</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Process rank: </span><span class="si">%s</span><span class="s2">, device: </span><span class="si">%s</span><span class="s2">, n_gpu: </span><span class="si">%s</span><span class="s2">, distributed training: </span><span class="si">%s</span><span class="s2">, 16-bits training: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                   <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">fp16</span><span class="p">)</span>
    <span class="c1"># Set the random seed</span>
    <span class="n">args</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="c1"># print(&quot;seed:&quot;, args.seed)</span>
    <span class="n">set_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="c1"># 多分类数量</span>
    <span class="n">labels_num</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="c1"># Data Preprocess</span>


    <span class="c1"># Load pretrained model and tokenizer</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>  <span class="c1"># Barrier to make sure only the first process in distributed training download model &amp; vocab</span>
    <span class="n">args</span><span class="o">.</span><span class="n">start_epoch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">args</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">checkpoint_last</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;checkpoint-last&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">):</span>
        <span class="n">args</span><span class="o">.</span><span class="n">model_name_or_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;pytorch_model.bin&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">config_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;config.json&#39;</span><span class="p">)</span>
        <span class="n">idx_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;idx_file.txt&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">idx_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">idxf</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">start_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idxf</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">step_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="s1">&#39;step_file.txt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">step_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">step_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stepf</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stepf</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reload model from </span><span class="si">{}</span><span class="s2">, resume from </span><span class="si">{}</span><span class="s2"> epoch&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">checkpoint_last</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">))</span>

    <span class="c1">#</span>
    <span class="n">config_class</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">tokenizer_class</span> <span class="o">=</span> <span class="n">MODEL_CLASSES</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">model_type</span><span class="p">]</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">config_class</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config_name</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">config_name</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">,</span>
                                          <span class="n">cache_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_dir</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cache_dir</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">num_labels</span> <span class="o">=</span> <span class="n">labels_num</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer_class</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tokenizer_name</span><span class="p">,</span>
                                                <span class="n">do_lower_case</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_lower_case</span><span class="p">,</span>
                                                <span class="n">cache_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_dir</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cache_dir</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">block_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">max_len_single_sentence</span>  <span class="c1"># Our input block size will be the max possible for the model</span>
    <span class="n">args</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">block_size</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">max_len_single_sentence</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">,</span>
                                            <span class="n">from_tf</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="s1">&#39;.ckpt&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">model_name_or_path</span><span class="p">),</span>
                                            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                            <span class="n">cache_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cache_dir</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cache_dir</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span></div>

<div class="viewcode-block" id="codebert_train"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.codebert_train">[docs]</a><span class="k">def</span> <span class="nf">codebert_train</span><span class="p">(</span><span class="n">model_pre</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trains the model on a specified training dataset using provided configurations and tokenizer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_pre : object</span>
<span class="sd">        Pre-trained model instance to be used as the base model.</span>
<span class="sd">    config : object</span>
<span class="sd">        Configuration of the model, including hyperparameters.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance to process the dataset.</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser with configurations for training, such as file paths, batch sizes, and device setup.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTMModel</span><span class="p">(</span><span class="n">model_pre</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">prom_loop</span> <span class="o">=</span> <span class="n">Bug_detection</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># dataset partition</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dataset partition...&quot;</span><span class="p">)</span>
    <span class="n">prom_loop</span><span class="o">.</span><span class="n">data_partitioning</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;../../../benchmark/Bug&#39;</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">num_folders</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span> <span class="o">=</span> <span class="n">onehot</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">train_data_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>  <span class="c1"># End of barrier to make sure only the first process in distributed training download model &amp; vocab</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Training/evaluation parameters </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>  <span class="c1"># Barrier to make sure only the first process in distributed training process the dataset, and the others will use the cache</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting features...&quot;</span><span class="p">)</span>
        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">train_data_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training the underlying model...&quot;</span><span class="p">)</span>
        <span class="n">best_acc</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">nni</span><span class="o">.</span><span class="n">report_final_result</span><span class="p">(</span><span class="n">best_acc</span><span class="p">)</span></div>

<div class="viewcode-block" id="codebert_deploy"><a class="viewcode-back" href="../case_study/BugD/VD_vulde.html#VD_vulde.codebert_deploy">[docs]</a><span class="k">def</span> <span class="nf">codebert_deploy</span><span class="p">(</span><span class="n">model_pre</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploys the model with incremental learning on a specified training dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_pre : object</span>
<span class="sd">        Pre-trained model instance to be used as the base model.</span>
<span class="sd">    config : object</span>
<span class="sd">        Configuration of the model, including hyperparameters.</span>
<span class="sd">    tokenizer : object</span>
<span class="sd">        Tokenizer instance to process the dataset.</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        Argument parser with configurations for deployment, such as file paths, batch sizes, and device setup.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTMModel</span><span class="p">(</span><span class="n">model_pre</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">prom_loop</span> <span class="o">=</span> <span class="n">Bug_detection</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># dataset partition</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dataset partition...&quot;</span><span class="p">)</span>
    <span class="n">prom_loop</span><span class="o">.</span><span class="n">data_partitioning</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;../../../benchmark/Bug&#39;</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">num_folders</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span> <span class="o">=</span> <span class="n">onehot</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">train_data_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>  <span class="c1"># End of barrier to make sure only the first process in distributed training download model &amp; vocab</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Training/evaluation parameters </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">do_train</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>  <span class="c1"># Barrier to make sure only the first process in distributed training process the dataset, and the others will use the cache</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting features...&quot;</span><span class="p">)</span>
        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">train_data_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">one_hot_vectors</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">suffixes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">local_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training the underlying model...&quot;</span><span class="p">)</span>
        <span class="n">increment_acc</span> <span class="o">=</span> <span class="n">deploy</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
        <span class="c1"># increment_acc = train(args, train_dataset, model, tokenizer)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The best incremental accuracy is: &quot;</span><span class="p">,</span> <span class="n">increment_acc</span><span class="p">)</span>
    <span class="n">nni</span><span class="o">.</span><span class="n">report_final_result</span><span class="p">(</span><span class="n">increment_acc</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># initial the model parameters</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;initial the model parameters...&quot;</span><span class="p">)</span>
    <span class="n">model_pre</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">model_initial</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
        <span class="n">codebert_train</span><span class="p">(</span><span class="n">model_pre</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;deploy&#39;</span><span class="p">:</span>
        <span class="n">codebert_deploy</span><span class="p">(</span><span class="n">model_pre</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="c1"># codebert_train(model_pre, config, tokenizer, args)</span>
    <span class="c1"># codebert_deploy(model_pre, config, tokenizer, args)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --output_dir=./saved_models     --model_type=roberta     --tokenizer_name=microsoft/codebert-base     --model_name_or_path=microsoft/codebert-base   --do_train  --do_eval     --do_test     --train_data_file=../../../benchmark/Bug/train.jsonl     --eval_data_file=../../../benchmark/Bug/valid.jsonl     --test_data_file=../../../benchmark/Bug/test.jsonl --evaluate_during_training</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1"># codebert_train(model_pre, config, tokenizer, args)</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, _.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>